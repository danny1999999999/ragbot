<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÅäÂ§©Ê©üÂô®‰∫∫ÊúçÂãôÁÆ°ÁêÜÂô®</title>
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f4f4f9; }
        h1, h2 { color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .bot-list, .create-bot { margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #e9ecef; }
        button { cursor: pointer; padding: 8px 12px; border-radius: 4px; border: none; color: white; margin: 2px; }
        .btn-start { background-color: #28a745; }
        .btn-stop { background-color: #dc3545; }
        .btn-config { background-color: #007bff; }
        .btn-edit { background-color: #17a2b8; }
        .btn-delete { background-color: #dc3545; }
        .btn-save { background-color: #28a745; }
        .btn-cancel { background-color: #6c757d; }
        .btn-logout { background-color: #6c757d; }
        .btn-back { background-color: #6c757d; padding: 10px 20px; text-decoration: none; color: white; border-radius: 4px; display: inline-block; margin-bottom: 20px; }
        .status-running { color: #28a745; font-weight: bold; }
        .status-stopped { color: #6c757d; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select { width: 95%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        .form-group textarea { height: 100px; resize: vertical; }
        #message { margin-top: 15px; padding: 10px; border-radius: 4px; display: none; }
        .msg-success { background-color: #d4edda; color: #155724; }
        .msg-error { background-color: #f8d7da; color: #721c24; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* È†ÅÈù¢ÂàáÊèõÊ®£Âºè */
        .page { display: none; }
        .page.active { display: block; }
        
        /* Ê®ôÁ±§È†ÅÊ®£Âºè */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            margin-right: 2px;
            color: #495057;
        }
        .tab.active {
            background: white;
            border-bottom-color: #007bff;
            color: #007bff;
        }
        .tab:hover {
            background: #e9ecef;
            color: #007bff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Ë©≥Á¥∞‰ø°ÊÅØÂç°Áâá */
        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .info-card h4 {
            margin-top: 0;
            color: #495057;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .info-label {
            font-weight: bold;
            color: #6c757d;
        }
        .info-value {
            color: #495057;
        }
        
        /* Ë°®Ê†ºÊìç‰ΩúÊåâÈàïÁµÑ */
        .btn-group {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        /* ÁãÄÊÖãÂæΩÁ´† */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .status-running {
            background-color: #d4edda;
            color: #155724;
        }
        .status-stopped {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* Â∞çË©±Ë®òÈåÑÂ∞àÁî®Ê®£Âºè */
        .conversation-table {
            font-size: 0.9em;
        }
        .conversation-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            text-align: center;
        }
        .conversation-table td {
            vertical-align: top;
        }
        .chunk-btn {
            padding: 2px 6px;
            margin: 1px;
            font-size: 0.8em;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .chunk-btn:hover {
            background-color: #138496;
        }
        .conversation-meta {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 4px;
        }
        .error-row {
            background-color: #fff5f5 !important;
        }
        .success-row {
            background-color: #f8fff8;
        }

        /* È°ØÁ§∫ÂêçÁ®±Áõ∏ÈóúÊ®£Âºè */
        .display-name-group {
            background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
            border: 1px solid #e1f5fe;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .display-name-group h4 {
            margin: 0 0 15px 0;
            color: #1976d2;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .field-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .field-indicator.user-visible {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .field-indicator.system-internal {
            background-color: #f5f5f5;
            color: #6c757d;
        }

        /* Ê©üÂô®‰∫∫ÂêçÁ®±È°ØÁ§∫Ê®£Âºè */
        .bot-name-display {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .bot-display-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bot-tech-name {
            font-size: 0.85em;
            color: #6c757d;
            font-weight: normal;
        }

        .bot-tech-name::before {
            content: "‚öôÔ∏è";
            margin-right: 4px;
        }

        /* Â≠óÁ¨¶Ë®àÊï∏Âô® */
        .char-counter {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            color: #6c757d;
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .char-counter.warning {
            color: #fd7e14;
        }

        .char-counter.danger {
            color: #dc3545;
        }

        /* Ë°®ÂñÆÈ©óË≠âÊ®£Âºè */
        .form-group.has-validation .form-control:invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .form-group.has-validation .form-control:valid {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .validation-message {
            font-size: 0.875em;
            margin-top: 5px;
            padding: 4px 0;
        }

        .validation-message.error {
            color: #dc3545;
        }

        .validation-message.success {
            color: #28a745;
        }

        /* Modal Ê®£ÂºèÔºàÂÉÖÁî®Êñº Chunk Ë©≥ÊÉÖÁ≠âËºîÂä©ÂäüËÉΩÔºâ */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            justify-content: center; 
            align-items: center; 
            z-index: 1000;
        }
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            width: 90%; 
            max-width: 800px; 
            max-height: 90vh; 
            overflow-y: auto;
        }

        /* Â§ßÂûã Modal Ê®£Âºè */
        .large-modal .modal-content {
            max-width: 1000px;
            width: 95%;
        }

        /* üÜï Áü•Ë≠òÂ∫´Áµ±Ë®à‰ø°ÊÅØÊ®£Âºè */
        .knowledge-stats {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border: 1px solid #c3e6c3;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .knowledge-stats .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9em;
        }

        .knowledge-stats .stat-label {
            color: #2d5a2d;
            font-weight: 600;
        }

        .knowledge-stats .stat-value {
            color: #1a4d1a;
            font-weight: bold;
        }
        
        /* ÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 768px) {
            .container { margin: 1em; padding: 15px; }
            table { font-size: 0.9em; }
            .btn-group { flex-direction: column; }
            .conversation-table { font-size: 0.8em; }
            .tabs { flex-wrap: wrap; }
            .tab { font-size: 0.9em; padding: 8px 12px; }

            .display-name-group {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .bot-display-name {
                font-size: 1em;
            }
            
            .bot-tech-name {
                font-size: 0.8em;
            }
            
            .field-indicator {
                font-size: 0.75em;
                padding: 1px 6px;
            }

            .knowledge-stats {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- ‰∏ªÂàóË°®È†ÅÈù¢ -->
    <div id="mainPage" class="page active">
        <div class="container">
            <!-- Ê®ôÈ°åÂíåÁôªÂá∫ -->
            <div class="header">
                <h1>ü§ñ ËÅäÂ§©Ê©üÂô®‰∫∫ÊúçÂãôÁÆ°ÁêÜÂô®</h1>
                <button onclick="logout()" class="btn-logout">ÁôªÂá∫</button>
            </div>
            
            <!-- ÂâµÂª∫Êñ∞Ê©üÂô®‰∫∫ -->
            <div class="create-bot">
                <h2>ÂâµÂª∫Êñ∞Ê©üÂô®‰∫∫</h2>
                <div class="display-name-group">
                    <h4>üéØ Ê©üÂô®‰∫∫ÂëΩÂêçË®≠ÂÆö</h4>
                    <form id="createBotForm">
                        <!-- È°ØÁ§∫ÂêçÁ®±Ê¨Ñ‰Ωç -->
                        <div class="form-group">
                            <label for="botDisplayName">
                                Ê©üÂô®‰∫∫È°ØÁ§∫ÂêçÁ®± 
                                <span class="field-indicator user-visible">üëÄ Áî®Êà∂ÂèØË¶ã</span>
                            </label>
                            <input type="text" id="botDisplayName" required maxlength="50" placeholder="‰æãÂ¶Ç: Êô∫ËÉΩË≤°ÂãôÈ°ßÂïè">
                            <small style="color: #6c757d;">ÈÄôÂÄãÂêçÁ®±ÊúÉÈ°ØÁ§∫Âú®ËÅäÂ§©ÁïåÈù¢È†ÇÈÉ®ÔºåËÆìÁî®Êà∂Êõ¥ÂÆπÊòìÁêÜËß£Ê©üÂô®‰∫∫ÁöÑÂäüËÉΩ</small>
                        </div>
                        
                        <!-- ÊäÄË°ìÂêçÁ®±Ê¨Ñ‰Ωç -->
                        <div class="form-group">
                            <label for="botName">
                                Ê©üÂô®‰∫∫ÊäÄË°ìÂêçÁ®± 
                                <span class="field-indicator system-internal">‚öôÔ∏è Á≥ªÁµ±ÂÖßÈÉ®</span>
                            </label>
                            <input type="text" id="botName" required pattern="[a-z0-9-_]+" placeholder="‰æãÂ¶Ç: finance-bot">
                            <small style="color: #6c757d;">Ëã±Êñá„ÄÅÊï∏Â≠ó„ÄÅÈÄ£Â≠óÁ¨¶ÔºåÁî®ÊñºÁ≥ªÁµ±ÂÖßÈÉ®Ë≠òÂà•ÔºåÂâµÂª∫Âæå‰∏çÂèØ‰øÆÊîπ</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="botPort">ÊúçÂãôÁ´ØÂè£ (‰æãÂ¶Ç: 8002)</label>
                            <input type="number" id="botPort" required min="1025" max="65535" placeholder="8002">
                        </div>
                        <div class="form-group">
                            <label for="systemRole">Á≥ªÁµ±ËßíËâ≤</label>
                            <textarea id="systemRole" rows="3" placeholder="ÊèèËø∞ÈÄôÂÄãÊ©üÂô®‰∫∫ÁöÑËßíËâ≤ÂíåÂäüËÉΩ..."></textarea>
                        </div>
                        <button type="submit" class="btn-config">üöÄ ÂâµÂª∫Ê©üÂô®‰∫∫</button>
                    </form>
                </div>
            </div>

            <!-- Ê©üÂô®‰∫∫ÂàóË°® -->
            <div class="bot-list">
                <h2>Ê©üÂô®‰∫∫ÂØ¶‰æãÂàóË°®</h2>
                <table id="botTable">
                    <thead>
                        <tr>
                            <th>Ê©üÂô®‰∫∫ÂêçÁ®±</th>
                            <th>ÁãÄÊÖã</th>
                            <th>Á´ØÂè£</th>
                            <th>Á≥ªÁµ±ËßíËâ≤</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="botTableBody">
                        <!-- JS ÂãïÊÖãÂ°´ÂÖ• -->
                    </tbody>
                </table>
            </div>

            <div id="message"></div>
        </div>
    </div>

    <!-- Ê©üÂô®‰∫∫ÁÆ°ÁêÜÈ†ÅÈù¢ -->
    <div id="managePage" class="page">
        <div class="container">
            <!-- È†ÇÈÉ®Â∞éËà™ -->
            <div class="header">
                <div>
                    <a href="#" onclick="showMainPage()" class="btn-back">‚Üê ËøîÂõûÂàóË°®</a>
                    <h1 id="managePageTitle">ÁÆ°ÁêÜÊ©üÂô®‰∫∫</h1>
                </div>
                <button onclick="logout()" class="btn-logout">ÁôªÂá∫</button>
            </div>
            
            <!-- Ê®ôÁ±§È†Å -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('info')">üìä Âü∫Êú¨‰ø°ÊÅØ</button>
                <button class="tab" onclick="switchTab('config')">‚öôÔ∏è ÈÖçÁΩÆË®≠ÂÆö</button>
                <button class="tab" onclick="switchTab('knowledge')">üìö Áü•Ë≠òÂ∫´</button>
                <button class="tab" onclick="switchTab('conversations')">üí¨ Â∞çË©±Ë®òÈåÑ</button>
            </div>

            <!-- Âü∫Êú¨‰ø°ÊÅØÊ®ôÁ±§ -->
            <div id="infoTab" class="tab-content active">
                <div class="info-card">
                    <h4>üìã Ê©üÂô®‰∫∫Âü∫Êú¨‰ø°ÊÅØ</h4>
                    <div id="botInfoDetails">
                        <!-- JS ÂãïÊÖãÂ°´ÂÖ• -->
                    </div>
                </div>
            </div>

            <!-- ÈÖçÁΩÆË®≠ÂÆöÊ®ôÁ±§ -->
            <div id="configTab" class="tab-content">
                <form id="editBotForm">
                    <!-- È°ØÁ§∫ÂêçÁ®±Á∑®ËºØÊ¨Ñ‰Ωç -->
                    <div class="form-group">
                        <label for="editDisplayName">
                            Ê©üÂô®‰∫∫È°ØÁ§∫ÂêçÁ®±
                            <span class="field-indicator user-visible">üëÄ Áî®Êà∂ÂèØË¶ã</span>
                        </label>
                        <input type="text" class="form-control" id="editDisplayName" maxlength="50" placeholder="Áî®Êà∂ÁúãÂà∞ÁöÑÊ©üÂô®‰∫∫ÂêçÁ®±">
                        <small style="color: #6c757d;">ÊúÄÂ§ö50ÂÄãÂ≠óÁ¨¶ÔºåÈÄôÂÄãÂêçÁ®±ÊúÉÈ°ØÁ§∫Âú®ËÅäÂ§©ÁïåÈù¢È†ÇÈÉ®</small>
                    </div>

                    <div class="form-group">
                        <label for="editSystemRole">Á≥ªÁµ±ËßíËâ≤ (System Role)</label>
                        <textarea class="form-control" id="editSystemRole" rows="4"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="editTemperature">Ê∫´Â∫¶ (Temperature)</label>
                            <input type="number" class="form-control" id="editTemperature" step="0.1" min="0" max="1">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="editMaxTokens">ÊúÄÂ§ßÊ¨äÊùñ (Max Tokens)</label>
                            <input type="number" class="form-control" id="editMaxTokens" step="100" min="100">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="editDynamicRecommendations">
                            <label class="custom-control-label" for="editDynamicRecommendations">ÂïüÁî® LLM ÂãïÊÖãÊé®Ëñ¶ÂïèÈ°å</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editDynamicRecommendationsCount">Êé®Ëñ¶ÂïèÈ°åÁîüÊïàÊ¨°Êï∏ (0ÁÇ∫ÁÑ°Èôê)</label>
                        <input type="number" class="form-control" id="editDynamicRecommendationsCount" min="0">
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="editCiteSources">
                            <label class="custom-control-label" for="editCiteSources">ÂïüÁî®ÂºïÁî®Ë≥áÊñô‰æÜÊ∫êÁ∂≤ÂùÄ</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editPort">ÊúçÂãôÁ´ØÂè£</label>
                        <input type="number" id="editPort" min="1025" max="65535" placeholder="8002">
                        <small style="color: #6c757d;">‚ö†Ô∏è ‰øÆÊîπÁ´ØÂè£ÈúÄË¶ÅÈáçÂïüÊ©üÂô®‰∫∫</small>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn-save">üíæ ‰øùÂ≠òÈÖçÁΩÆ</button>
                        <button type="button" class="btn-cancel" onclick="loadBotConfig()">üîÑ ÈáçÁΩÆ</button>
                    </div>
                </form>
            </div>

            <!-- Áü•Ë≠òÂ∫´Ê®ôÁ±§ -->
            <div id="knowledgeTab" class="tab-content">
                <h4>üìÅ Áü•Ë≠òÂ∫´Êñá‰ª∂ÁÆ°ÁêÜ</h4>
                
                <!-- üÜï Áü•Ë≠òÂ∫´Áµ±Ë®à‰ø°ÊÅØ -->
                <div id="knowledgeStats" class="knowledge-stats" style="display: none;">
                    <div class="stat-item">
                        <span class="stat-label">üìÑ Êñá‰ª∂Á∏ΩÊï∏:</span>
                        <span class="stat-value" id="totalFilesCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">üß© Á∏Ω Chunks:</span>
                        <span class="stat-value" id="totalChunksCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">üìä ÁãÄÊÖã:</span>
                        <span class="stat-value" id="knowledgeStatus">Â∞±Á∑í</span>
                    </div>
                </div>
                
                <!-- Êñá‰ª∂ÂàóË°®Ë°®Ê†º -->
                <div id="knowledgeFilesList" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                    <!-- JS ÂãïÊÖãÂ°´ÂÖ• -->
                </div>

                <!-- ‰∏äÂÇ≥ÂçÄÂ°ä -->
                <div class="form-group">
                    <label for="fileUpload">‰∏äÂÇ≥Êñ∞Êñá‰ª∂ (ÊîØÊè¥ .txt, .pdf, .docx, .md)</label>
                    <input type="file" id="fileUpload" accept=".txt,.pdf,.docx,.md">
                    <button id="uploadBtn" onclick="uploadFile()" class="btn-config" style="margin-top:10px;">
                        <span id="uploadIcon">üì§</span> ‰∏äÂÇ≥Êñá‰ª∂
                    </button>
                    <span id="uploadStatus" style="margin-left: 15px; color: #007bff; font-weight: bold;"></span>
                </div>
            </div>

            <!-- Â∞çË©±Ë®òÈåÑÊ®ôÁ±§ -->
            <div id="conversationsTab" class="tab-content">
                <h4>üí¨ Â∞çË©±Ë®òÈåÑÁÆ°ÁêÜ</h4>
                
                <!-- ÊêúÁ¥¢ÂíåÊéßÂà∂ÂçÄÂüü -->
                <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="conversationSearch" placeholder="ÊêúÁ¥¢Â∞çË©±ÂÖßÂÆπ..." style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px;">
                        <button onclick="searchConversations()" class="btn-config">üîç ÊêúÁ¥¢</button>
                        <button onclick="loadConversations(1)" class="btn-config">üîÑ ÈáçÁΩÆ</button>
                    </div>
                    <div>
                        <span id="conversationStats">ËºâÂÖ•‰∏≠...</span>
                    </div>
                </div>
                
                <!-- ÊâπÈáèÊìç‰ΩúÂçÄÂüü -->
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                    <button onclick="toggleSelectAll()" class="btn-config" id="selectAllBtn">‚òëÔ∏è ÂÖ®ÈÅ∏</button>
                    <button onclick="deleteSelectedConversations()" class="btn-delete" id="deleteSelectedBtn" disabled>üóëÔ∏è Âà™Èô§ÈÅ∏‰∏≠</button>
                    <span id="selectedCount" style="color: #6c757d; margin-left: 10px;">Â∑≤ÈÅ∏‰∏≠ 0 È†Ö</span>
                </div>
                
                <!-- ÂàÜÈ†ÅÊéßÂà∂ -->
                <div style="margin-bottom: 15px; display: flex; justify-content: center; align-items: center; gap: 10px;">
                    <button id="prevPageBtn" onclick="loadConversations(currentPage - 1)" class="btn-config" disabled>‚¨ÖÔ∏è ‰∏ä‰∏ÄÈ†Å</button>
                    <span id="pageInfo" style="margin: 0 15px;">È†ÅÈù¢ 1</span>
                    <button id="nextPageBtn" onclick="loadConversations(currentPage + 1)" class="btn-config" disabled>‰∏ã‰∏ÄÈ†Å ‚û°Ô∏è</button>
                </div>
                
                <!-- Â∞çË©±Ë®òÈåÑÂàóË°® -->
                <div id="conversationsList" style="max-height: 600px; overflow-y: auto;">
                    <!-- JS ÂãïÊÖãÂ°´ÂÖ• -->
                </div>
            </div>

            <!-- È†ÅÈù¢Â∫ïÈÉ®Êìç‰ΩúÊåâÈàï -->
            <hr style="margin-top: 30px;">
            
            <!-- È†ÅÈù¢ÂÖßË®äÊÅØÈ°ØÁ§∫ÂçÄÂüü -->
            <div id="pageMessage" style="margin: 15px 0; padding: 10px; border-radius: 4px; display: none;"></div>
            
            <div class="btn-group">
                <button onclick="showMainPage()" class="btn-cancel">‚Üê ËøîÂõûÂàóË°®</button>
                <button onclick="deleteBotConfirm()" class="btn-delete">üóëÔ∏è Âà™Èô§Ê©üÂô®‰∫∫</button>
            </div>
        </div>
    </div>

    <!-- Chunk ÂÖßÂÆπ Modal -->
    <div id="chunkModal" class="modal large-modal">
        <div class="modal-content">
            <h3 id="chunkModalTitle">Chunk ÂÖßÂÆπË©≥ÊÉÖ</h3>
            
            <!-- Chunk ÂÖÉÊï∏Êìö -->
            <div id="chunkMetadata" style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 5px;"></div>
            
            <!-- Chunk ÂÖßÂÆπ -->
            <div style="margin-bottom: 15px;">
                <h4>üìÑ ÂÖßÂÆπ</h4>
                <div id="chunkContent" style="background: white; padding: 15px; border: 1px solid #ddd; border-radius: 5px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4;"></div>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="closeChunkModal()" class="btn-cancel">ÈóúÈñâ</button>
            </div>
        </div>
    </div>

    <!-- Â∞çË©±Ë©≥ÊÉÖ Modal -->
    <div id="conversationDetailModal" class="modal large-modal">
        <div class="modal-content">
            <h3>üí¨ Â∞çË©±Ë©≥ÊÉÖ</h3>
            
            <div id="conversationDetailContent">
                <!-- JS ÂãïÊÖãÂ°´ÂÖ• -->
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="closeConversationDetailModal()" class="btn-cancel">ÈóúÈñâ</button>
            </div>
        </div>
    </div>

    <script>
        const createBotForm = document.getElementById('createBotForm');
        const editBotForm = document.getElementById('editBotForm');
        const botTableBody = document.getElementById('botTableBody');
        const messageDiv = document.getElementById('message');
        const pageMessageDiv = document.getElementById('pageMessage');
        let currentBotName = null;
        let currentBotConfig = null;

        // Â∞çË©±Ë®òÈåÑÁõ∏ÈóúËÆäÊï∏
        let currentPage = 1;
        let totalPages = 1;
        let selectedConversations = new Set();
        let allConversationsOnPage = [];

        // È†ÅÈù¢ÂàáÊèõÂäüËÉΩ
        function showMainPage() {
            document.getElementById('mainPage').classList.add('active');
            document.getElementById('managePage').classList.remove('active');
            currentBotName = null;
            currentBotConfig = null;
            fetchBots(); // Âà∑Êñ∞ÂàóË°®
        }

        function showManagePage(botName) {
            currentBotName = botName;
            document.getElementById('mainPage').classList.remove('active');
            document.getElementById('managePage').classList.add('active');
            document.getElementById('managePageTitle').textContent = `ÁÆ°ÁêÜÊ©üÂô®‰∫∫: ${botName}`;
            
            // ÂàáÊèõÂà∞Á¨¨‰∏ÄÂÄãÊ®ôÁ±§‰∏¶ËºâÂÖ•ÈÖçÁΩÆ
            switchTab('info');
            loadBotConfig();
        }

        // È°ØÁ§∫Ë®äÊÅØÂáΩÊï∏
        function showMessage(message, isError = false, inPage = false) {
            const targetDiv = inPage ? pageMessageDiv : messageDiv;
            targetDiv.textContent = message;
            targetDiv.className = isError ? 'msg-error' : 'msg-success';
            targetDiv.style.display = 'block';
            setTimeout(() => { targetDiv.style.display = 'none'; }, 5000);
        }

        // È°ØÁ§∫ÂêçÁ®±È©óË≠âÂíåÂ≠óÁ¨¶Ë®àÊï∏ÂäüËÉΩ
        function setupDisplayNameValidation() {
            const displayNameInputs = ['botDisplayName', 'editDisplayName'];
            
            displayNameInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (!input) return;
                
                // ÂâµÂª∫Â≠óÁ¨¶Ë®àÊï∏Âô®
                const counter = document.createElement('span');
                counter.className = 'char-counter';
                input.parentElement.style.position = 'relative';
                input.parentElement.appendChild(counter);
                
                // Ê∑ªÂä†È©óË≠âÊ∂àÊÅØÂÆπÂô®
                const validationMsg = document.createElement('div');
                validationMsg.className = 'validation-message';
                input.parentElement.appendChild(validationMsg);
                
                // ÂØ¶ÊôÇÈ©óË≠â
                input.addEventListener('input', function() {
                    const length = this.value.length;
                    const maxLength = 50;
                    
                    // Êõ¥Êñ∞Ë®àÊï∏Âô®
                    counter.textContent = `${length}/${maxLength}`;
                    counter.className = 'char-counter';
                    
                    if (length > maxLength * 0.8) {
                        counter.classList.add('warning');
                    }
                    if (length >= maxLength) {
                        counter.classList.add('danger');
                    }
                    
                    // È©óË≠âÊ∂àÊÅØ
                    if (length === 0) {
                        validationMsg.textContent = 'Ë´ãËº∏ÂÖ•È°ØÁ§∫ÂêçÁ®±';
                        validationMsg.className = 'validation-message error';
                        this.parentElement.classList.add('has-validation');
                    } else if (length > maxLength) {
                        validationMsg.textContent = 'È°ØÁ§∫ÂêçÁ®±ÈÅéÈï∑';
                        validationMsg.className = 'validation-message error';
                        this.parentElement.classList.add('has-validation');
                    } else {
                        validationMsg.textContent = 'È°ØÁ§∫ÂêçÁ®±Ê†ºÂºèÊ≠£Á¢∫';
                        validationMsg.className = 'validation-message success';
                        this.parentElement.classList.add('has-validation');
                    }
                });
                
                // ÂàùÂßãÂåñË®àÊï∏Âô®
                input.dispatchEvent(new Event('input'));
            });
        }

        // Ë°®ÂñÆÊèê‰∫§ÂâçÁöÑÊúÄÁµÇÈ©óË≠â
        function validateDisplayName(displayName) {
            if (!displayName || displayName.trim().length === 0) {
                return { valid: false, message: 'È°ØÁ§∫ÂêçÁ®±‰∏çËÉΩÁÇ∫Á©∫' };
            }
            
            if (displayName.length > 50) {
                return { valid: false, message: 'È°ØÁ§∫ÂêçÁ®±‰∏çËÉΩË∂ÖÈÅé50ÂÄãÂ≠óÁ¨¶' };
            }
            
            // Ê™¢Êü•ÁâπÊÆäÂ≠óÁ¨¶ÔºàÂèØÈÅ∏Ôºâ
            const invalidChars = /[<>"\\'&]/;
            if (invalidChars.test(displayName)) {
                return { valid: false, message: 'È°ØÁ§∫ÂêçÁ®±ÂåÖÂê´ÁÑ°ÊïàÂ≠óÁ¨¶' };
            }
            
            return { valid: true, message: 'È°ØÁ§∫ÂêçÁ®±ÊúâÊïà' };
        }

        // ÁôªÂá∫ÂäüËÉΩ
        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                window.location.href = '/login';
            }
        }

        // Ê®ôÁ±§È†ÅÂàáÊèõ
        function switchTab(tabName) {
            // Èö±ËóèÊâÄÊúâÊ®ôÁ±§ÂÖßÂÆπ
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Ê†πÊìöÊ®ôÁ±§ËºâÂÖ•Áõ∏ÊáâÂÖßÂÆπ
            if (tabName === 'knowledge' && currentBotName) {
                loadKnowledgeFiles(currentBotName);
            } else if (tabName === 'conversations' && currentBotName) {
                currentPage = 1;
                selectedConversations.clear();
                updateSelectedUI();
                loadConversations(currentPage);
            }
        }

        // Áç≤ÂèñÊ©üÂô®‰∫∫ÂàóË°®
        async function fetchBots() {
            try {
                const response = await fetch('/api/bots');
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                const bots = await response.json();
                renderBotTable(bots);
            } catch (error) {
                showMessage('ÁÑ°Ê≥ïÁç≤ÂèñÊ©üÂô®‰∫∫ÂàóË°®: ' + error.message, true);
            }
        }

        // Ê∏≤ÊüìÊ©üÂô®‰∫∫Ë°®Ê†º - ÊîØÊè¥È°ØÁ§∫ÂêçÁ®±
        function renderBotTable(bots) {
            botTableBody.innerHTML = '';
            if (bots.length === 0) {
                botTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#6c757d;">Â∞öÊú™ÂâµÂª∫‰ªª‰ΩïÊ©üÂô®‰∫∫</td></tr>';
                return;
            }

            bots.forEach(bot => {
                const row = document.createElement('tr');
                const isRunning = bot.status === 'running';
                const statusClass = isRunning ? 'status-running' : 'status-stopped';
                const statusText = isRunning ? 'ÈÅãË°å‰∏≠' : 'Â∑≤ÂÅúÊ≠¢';
                const toggleAction = isRunning ? 'stop' : 'start';
                const toggleText = isRunning ? '‚èπÔ∏è ÂÅúÊ≠¢' : '‚ñ∂Ô∏è ÂïüÂãï';
                const toggleClass = isRunning ? 'btn-stop' : 'btn-start';
                
                // È°ØÁ§∫ÂêçÁ®±ÂÑ™ÂÖàÔºåÊäÄË°ìÂêçÁ®±‰ΩúÁÇ∫ÂâØË≥áË®ä
                const displayName = bot.display_name || bot.name;
                const techNameInfo = (bot.display_name && bot.display_name !== bot.name) ? 
                    `<div class="bot-tech-name">ÊäÄË°ìÂêçÁ®±: ${bot.name}</div>` : '';
                
                row.innerHTML = `
                    <td>
                        <div class="bot-name-display">
                            <div class="bot-display-name">${displayName}</div>
                            ${techNameInfo}
                        </div>
                    </td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${isRunning ? `<a href="http://localhost:8000/${bot.name}" target="_blank" style="color:#007bff;" title="ÈÄöÈÅé Gateway Ë®™Âïè">${bot.port} üîó</a>` : bot.port}</td>
                    <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis;">${bot.system_role || 'Êú™Ë®≠ÂÆö'}</td>
                    <td>
                        <div class="btn-group">
                            <button class="${toggleClass}" onclick="toggleBot('${bot.name}', '${toggleAction}')">${toggleText}</button>
                            <button class="btn-edit" onclick="showManagePage('${bot.name}')">‚öôÔ∏è ÁÆ°ÁêÜ</button>
                        </div>
                    </td>
                `;
                botTableBody.appendChild(row);
            });
        }

        // ÂïüÂãï/ÂÅúÊ≠¢Ê©üÂô®‰∫∫
        async function toggleBot(botName, action) {
            try {
                const response = await fetch(`/api/bots/${botName}/${action}`, { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    showMessage(data.message);
                    fetchBots();
                } else {
                    throw new Error(data.detail || data.message);
                }
            } catch (error) {
                showMessage(`${action === 'start' ? 'ÂïüÂãï' : 'ÂÅúÊ≠¢'} ${botName} Â§±Êïó: ` + error.message, true);
            }
        }

        // ÂâµÂª∫Êñ∞Ê©üÂô®‰∫∫ - ÂåÖÂê´È°ØÁ§∫ÂêçÁ®±
        createBotForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const botName = document.getElementById('botName').value;
            const displayName = document.getElementById('botDisplayName').value.trim();
            const port = document.getElementById('botPort').value;
            const systemRole = document.getElementById('systemRole').value;

            // È©óË≠âÈ°ØÁ§∫ÂêçÁ®±
            const validation = validateDisplayName(displayName);
            if (!validation.valid) {
                showMessage(validation.message, true);
                return;
            }

            try {
                const response = await fetch('/api/bots/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        bot_name: botName, 
                        display_name: displayName,
                        port: parseInt(port),
                        system_role: systemRole
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage(data.message);
                    createBotForm.reset();
                    // ÈáçÁΩÆÂ≠óÁ¨¶Ë®àÊï∏Âô®
                    setupDisplayNameValidation();
                    fetchBots();
                } else {
                    throw new Error(data.detail || data.message);
                }
            } catch (error) {
                showMessage('ÂâµÂª∫Â§±Êïó: ' + error.message, true);
            }
        });

        // ËºâÂÖ•Ê©üÂô®‰∫∫ÈÖçÁΩÆ - ÂåÖÂê´È°ØÁ§∫ÂêçÁ®±
        async function loadBotConfig() {
            if (!currentBotName) return;
            
            try {
                const response = await fetch(`/api/bots/${currentBotName}/config`);
                if (response.ok) {
                    const data = await response.json();
                    currentBotConfig = data.config;
                    
                    // Â°´ÂÖÖÂü∫Êú¨‰ø°ÊÅØ
                    displayBotInfo(currentBotConfig);
                    
                    // Â°´ÂÖÖÁ∑®ËºØË°®ÂñÆÔºåÂåÖÊã¨È°ØÁ§∫ÂêçÁ®±
                    document.getElementById('editDisplayName').value = currentBotConfig.display_name || currentBotConfig.bot_name || '';
                    document.getElementById('editSystemRole').value = currentBotConfig.system_role || '';
                    document.getElementById('editTemperature').value = currentBotConfig.temperature || 0.7;
                    document.getElementById('editMaxTokens').value = currentBotConfig.max_tokens || 2000;
                    document.getElementById('editPort').value = currentBotConfig.port || '';
                    
                    // Ê≠£Á¢∫Ë®≠ÁΩÆ checkbox ÁãÄÊÖã
                    document.getElementById('editDynamicRecommendations').checked = currentBotConfig.dynamic_recommendations_enabled === true;
                    document.getElementById('editDynamicRecommendationsCount').value = currentBotConfig.dynamic_recommendations_count || 0;
                    document.getElementById('editCiteSources').checked = currentBotConfig.cite_sources_enabled === true;
                    
                    // ÈáçÊñ∞ÂàùÂßãÂåñÈ°ØÁ§∫ÂêçÁ®±È©óË≠â
                    setupDisplayNameValidation();
                    
                } else {
                    throw new Error('ÁÑ°Ê≥ïËºâÂÖ•Ê©üÂô®‰∫∫ÈÖçÁΩÆ');
                }
            } catch (error) {
                showMessage('ËºâÂÖ•ÈÖçÁΩÆÂ§±Êïó: ' + error.message, true, true);
            }
        }

        // È°ØÁ§∫Ê©üÂô®‰∫∫Âü∫Êú¨‰ø°ÊÅØ - ÂåÖÂê´È°ØÁ§∫ÂêçÁ®±
        function displayBotInfo(config) {
            const infoDiv = document.getElementById('botInfoDetails');
            const createdAt = config.created_at ? new Date(config.created_at).toLocaleString('zh-TW') : 'Êú™Áü•';
            const updatedAt = config.updated_at ? new Date(config.updated_at).toLocaleString('zh-TW') : 'Êú™Êõ¥Êñ∞';
            
            // È°ØÁ§∫ÂêçÁ®±ËôïÁêÜ
            const displayName = config.display_name || config.bot_name || 'Êú™Ë®≠ÂÆö';
            const techName = config.bot_name || 'Êú™Áü•';
            
            infoDiv.innerHTML = `
                <div class="info-row">
                    <span class="info-label">È°ØÁ§∫ÂêçÁ®±:</span>
                    <span class="info-value">${displayName}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ÊäÄË°ìÂêçÁ®±:</span>
                    <span class="info-value">${techName}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ÊúçÂãôÁ´ØÂè£:</span>
                    <span class="info-value">${config.port || 'Êú™Ë®≠ÂÆö'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ê∫´Â∫¶ÂèÉÊï∏:</span>
                    <span class="info-value">${config.temperature || 0.7}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ÊúÄÂ§ß Token:</span>
                    <span class="info-value">${config.max_tokens || 2000}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ÂãïÊÖãÊé®Ëñ¶ÂïèÈ°å:</span>
                    <span class="info-value">${config.dynamic_recommendations_enabled ? '‚úÖ Â∑≤ÂïüÁî®' : '‚ùå Êú™ÂïüÁî®'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ÂºïÁî®‰æÜÊ∫ê:</span>
                    <span class="info-value">${config.cite_sources_enabled ? '‚úÖ Â∑≤ÂïüÁî®' : '‚ùå Êú™ÂïüÁî®'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ÂâµÂª∫ËÄÖ:</span>
                    <span class="info-value">${config.created_by || 'Êú™Áü•'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ÂâµÂª∫ÊôÇÈñì:</span>
                    <span class="info-value">${createdAt}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ÊúÄÂæåÊõ¥Êñ∞:</span>
                    <span class="info-value">${updatedAt}</span>
                </div>
                <div style="margin-top: 15px;">
                    <div class="info-label">Á≥ªÁµ±ËßíËâ≤:</div>
                    <div style="background: white; padding: 10px; border-radius: 4px; margin-top: 5px; white-space: pre-wrap;">${config.system_role || 'Êú™Ë®≠ÂÆö'}</div>
                </div>
            `;
        }

        // ‰øùÂ≠òÊ©üÂô®‰∫∫ÈÖçÁΩÆ - ÂåÖÂê´È°ØÁ§∫ÂêçÁ®±
        editBotForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentBotName) return;

            const displayName = document.getElementById('editDisplayName').value.trim();
            const systemRole = document.getElementById('editSystemRole').value;
            const temperature = parseFloat(document.getElementById('editTemperature').value);
            const maxTokens = parseInt(document.getElementById('editMaxTokens').value);
            const port = parseInt(document.getElementById('editPort').value);
            
            // È©óË≠âÈ°ØÁ§∫ÂêçÁ®±
            const validation = validateDisplayName(displayName);
            if (!validation.valid) {
                showMessage(validation.message, true, true);
                return;
            }
            
            // Ê≠£Á¢∫ËÆÄÂèñ checkbox ÂÄº
            const dynamicRecommendationsEnabled = document.getElementById('editDynamicRecommendations').checked;
            const dynamicRecommendationsCount = parseInt(document.getElementById('editDynamicRecommendationsCount').value) || 0;
            const citeSourcesEnabled = document.getElementById('editCiteSources').checked;

            try {
                const response = await fetch(`/api/bots/${currentBotName}/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        display_name: displayName,
                        system_role: systemRole,
                        temperature: temperature,
                        max_tokens: maxTokens,
                        port: port,
                        dynamic_recommendations_enabled: dynamicRecommendationsEnabled,
                        dynamic_recommendations_count: dynamicRecommendationsCount,
                        cite_sources_enabled: citeSourcesEnabled
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    showMessage('ÈÖçÁΩÆÂ∑≤‰øùÂ≠òÊàêÂäüÔºÅ', false, true);
                    await loadBotConfig(); // ÈáçÊñ∞ËºâÂÖ•ÈÖçÁΩÆ
                } else {
                    throw new Error(data.error || data.message);
                }
            } catch (error) {
                showMessage('‰øùÂ≠òÈÖçÁΩÆÂ§±Êïó: ' + error.message, true, true);
            }
        });

        // üÜï ‰øÆÊ≠£ÂæåÁöÑËºâÂÖ•Áü•Ë≠òÂ∫´Êñá‰ª∂ÂáΩÊï∏
        async function loadKnowledgeFiles(botName) {
            const listDiv = document.getElementById('knowledgeFilesList');
            const statsDiv = document.getElementById('knowledgeStats');
            const totalFilesEl = document.getElementById('totalFilesCount');
            const totalChunksEl = document.getElementById('totalChunksCount');
            const statusEl = document.getElementById('knowledgeStatus');
            
            listDiv.innerHTML = '<p>Ê≠£Âú®Áç≤ÂèñÊñá‰ª∂ÂàóË°®...</p>';
            statsDiv.style.display = 'none';

            try {
                const response = await fetch(`/api/bots/${botName}/knowledge/files`);
                if (!response.ok) throw new Error(`‰º∫ÊúçÂô®ÈåØË™§: ${response.status}`);
                
                // üîß ‰øÆÊ≠£ÔºöÊ≠£Á¢∫ËôïÁêÜÂæåÁ´ØËøîÂõûÁöÑÂ∞çË±°Ê†ºÂºè
                const responseData = await response.json();
                console.log('API ÂõûÊáâ:', responseData); // Ë™øË©¶Áî®

                let documents = [];
                let totalFiles = 0;
                let apiMessage = '';

                // ËôïÁêÜ‰∏çÂêåÁöÑÈüøÊáâÊ†ºÂºè
                if (responseData.success === false) {
                    // ÈåØË™§ÊÉÖÊ≥Å
                    throw new Error(responseData.message || 'Áç≤ÂèñÊñá‰ª∂ÂàóË°®Â§±Êïó');
                } else if (responseData.documents && Array.isArray(responseData.documents)) {
                    // Ê®ôÊ∫ñÂ∞çË±°Ê†ºÂºè
                    documents = responseData.documents;
                    totalFiles = responseData.total || documents.length;
                    apiMessage = responseData.message || '';
                } else if (Array.isArray(responseData)) {
                    // ËàäÁöÑÊï∏ÁµÑÊ†ºÂºèÔºàÂÇôÁî®Áõ∏ÂÆπÔºâ
                    documents = responseData;
                    totalFiles = documents.length;
                } else {
                    throw new Error("API ËøîÂõûÁöÑË≥áÊñôÊ†ºÂºè‰∏çÊ≠£Á¢∫");
                }

                // È°ØÁ§∫Áµ±Ë®à‰ø°ÊÅØ
                totalFilesEl.textContent = totalFiles;
                statusEl.textContent = apiMessage || (totalFiles > 0 ? 'Â∞±Á∑í' : 'Á©∫');
                statsDiv.style.display = 'flex';

                if (documents.length === 0) {
                    totalChunksEl.textContent = '0';
                    listDiv.innerHTML = '<p style="color:#6c757d; text-align:center; padding: 20px;">Ê≠§Áü•Ë≠òÂ∫´‰∏≠Ê≤íÊúâÊñá‰ª∂„ÄÇ</p>';
                    return;
                }

                // Âª∫Á´ãÊñá‰ª∂ÂàóË°®Ë°®Ê†º
                let tableHtml = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th style="padding: 12px; text-align: left;">Êñá‰ª∂Âêç</th>
                                <th style="padding: 12px; text-align: center;">Chunks</th>
                                <th style="padding: 12px; text-align: left;">‰∏äÂÇ≥ËÄÖ</th>
                                <th style="padding: 12px; text-align: left;">‰∏äÂÇ≥ÊôÇÈñì</th>
                                <th style="padding: 12px; text-align: center;">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                let totalChunks = 0;
                documents.forEach(doc => {
                    const filename = doc.filename || doc.name || 'unknown';
                    const safeFilename = filename.replace(/\./g, '-');
                    
                    tableHtml += `
                        <tr id="file-row-${safeFilename}" style="border-bottom: 1px solid #eee;">
                            <td style="padding: 10px; word-break: break-all;">üìÑ ${filename}</td>
                            <td id="chunk-count-${safeFilename}" style="padding: 10px; text-align: center;">${doc.chunk_count || '...'}</td>
                            <td id="uploader-${safeFilename}" style="padding: 10px;">${doc.uploaded_by || '...'}</td>
                            <td id="upload-time-${safeFilename}" style="padding: 10px;">${doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleString('zh-TW') : '...'}</td>
                            <td style="padding: 10px; text-align: center;">
                                <button onclick="deleteFile('${botName}', '${filename}')" class="btn-delete" style="padding: 5px 10px; font-size: 0.9em; background-color: #dc3545; color: white;">üóëÔ∏è Âà™Èô§</button>
                            </td>
                        </tr>
                    `;
                    
                    // Á¥ØË®à chunks
                    if (doc.chunk_count && typeof doc.chunk_count === 'number') {
                        totalChunks += doc.chunk_count;
                    }
                });
                
                tableHtml += '</tbody></table>';
                listDiv.innerHTML = tableHtml;

                // Êõ¥Êñ∞Á∏Ω chunks Êï∏
                totalChunksEl.textContent = totalChunks;

                // Â∞çÊñºÊ≤íÊúâË©≥Á¥∞‰ø°ÊÅØÁöÑÊñá‰ª∂ÔºåÁï∞Ê≠•Áç≤Âèñ
                documents.forEach(doc => {
                    const filename = doc.filename || doc.name;
                    if (!doc.chunk_count || !doc.uploaded_by) {
                        fetchFileDetails(botName, filename);
                    }
                });

            } catch (error) {
                console.error('ËºâÂÖ•Áü•Ë≠òÂ∫´Êñá‰ª∂Â§±Êïó:', error);
                listDiv.innerHTML = `<p style="color:red; text-align:center; padding: 20px;">ËºâÂÖ•Êñá‰ª∂ÂàóË°®Â§±Êïó: ${error.message}</p>`;
                statusEl.textContent = 'ÈåØË™§';
                totalFilesEl.textContent = '0';
                totalChunksEl.textContent = '0';
                statsDiv.style.display = 'flex';
            }
        }

        // Áç≤ÂèñÂñÆÂÄãÊñá‰ª∂ÁöÑË©≥Á¥∞Ë≥áË®ä
        async function fetchFileDetails(botName, filename) {
            try {
                const safeFilename = filename.replace(/\./g, '-');
                const response = await fetch(`/api/bots/${botName}/knowledge/files/${filename}/details`);
                if (!response.ok) throw new Error('Áç≤ÂèñÂ§±Êïó');
                
                const details = await response.json();

                const chunkCountEl = document.getElementById(`chunk-count-${safeFilename}`);
                const uploaderEl = document.getElementById(`uploader-${safeFilename}`);
                const uploadTimeEl = document.getElementById(`upload-time-${safeFilename}`);

                if (chunkCountEl) chunkCountEl.textContent = details.chunk_count || 'N/A';
                if (uploaderEl) uploaderEl.textContent = details.uploaded_by || 'Êú™Áü•';
                if (uploadTimeEl) uploadTimeEl.textContent = details.uploaded_at ? new Date(details.uploaded_at).toLocaleString('zh-TW') : 'Êú™Áü•';

                // Êõ¥Êñ∞Á∏Ω chunks Ë®àÊï∏
                if (details.chunk_count && typeof details.chunk_count === 'number') {
                    const currentTotal = parseInt(document.getElementById('totalChunksCount').textContent) || 0;
                    document.getElementById('totalChunksCount').textContent = currentTotal + details.chunk_count;
                }

            } catch (error) {
                console.warn(`Áç≤ÂèñÊñá‰ª∂ ${filename} ÁöÑË©≥Á¥∞‰ø°ÊÅØÂ§±Êïó:`, error);
                const safeFilename = filename.replace(/\./g, '-');
                const chunkCountEl = document.getElementById(`chunk-count-${safeFilename}`);
                const uploaderEl = document.getElementById(`uploader-${safeFilename}`);
                const uploadTimeEl = document.getElementById(`upload-time-${safeFilename}`);
                
                if (chunkCountEl) chunkCountEl.textContent = 'ÈåØË™§';
                if (uploaderEl) uploaderEl.textContent = '-';
                if (uploadTimeEl) uploadTimeEl.textContent = '-';
            }
        }

        // ‰∏äÂÇ≥Êñá‰ª∂
        async function uploadFile() {
            if (!currentBotName) return;
            const fileInput = document.getElementById('fileUpload');
            const file = fileInput.files[0];
            if (!file) {
                showMessage('Ë´ãÂÖàÈÅ∏Êìá‰∏ÄÂÄãÊñá‰ª∂ÂÜç‰∏äÂÇ≥„ÄÇ', true, true);
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            const uploadStatus = document.getElementById('uploadStatus');

            uploadBtn.disabled = true;
            uploadBtn.style.backgroundColor = '#6c757d';
            uploadStatus.textContent = '‰∏äÂÇ≥ËàáÂêëÈáèÂåñËôïÁêÜ‰∏≠ÔºåË´ãÁ®çÂÄô...';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`/api/bots/${currentBotName}/knowledge/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();

                if (response.ok && data.success) {
                    showMessage(`Êñá‰ª∂ ${file.name} Â∑≤ÊàêÂäü‰∏äÂÇ≥‰∏¶Á¥¢Âºï„ÄÇ`, false, true);
                    fileInput.value = '';
                    loadKnowledgeFiles(currentBotName);
                } else {
                    throw new Error(data.message || '‰∏äÂÇ≥Â§±ÊïóÔºåË´ãÊ™¢Êü•‰º∫ÊúçÂô®Êó•Ë™å„ÄÇ');
                }
            } catch (error) {
                showMessage('‰∏äÂÇ≥Â§±Êïó: ' + error.message, true, true);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.style.backgroundColor = '#007bff';
                uploadStatus.textContent = '';
            }
        }

        // Âà™Èô§Êñá‰ª∂
        async function deleteFile(botName, filename) {
            if (!confirm(`ÊÇ®Á¢∫ÂÆöË¶ÅÊ∞∏‰πÖÂà™Èô§Áü•Ë≠òÂ∫´‰∏≠ÁöÑÊñá‰ª∂ "${filename}" ÂóéÔºü\n\nÊ≠§Êìç‰ΩúÂ∞áÊúÉÔºö\n1. Âæû‰º∫ÊúçÂô®Âà™Èô§ÂéüÂßãÊñá‰ª∂„ÄÇ\n2. ÂæûÂêëÈáèË≥áÊñôÂ∫´‰∏≠ÁßªÈô§Áõ∏ÈóúÁöÑÊï∏Êìö„ÄÇ\n\nÈÄôÂÄãÊìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/bots/${botName}/knowledge/files/${filename}`, {
                    method: 'DELETE' 
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    showMessage(`Êñá‰ª∂ ${filename} Â∑≤ÊàêÂäüÂà™Èô§„ÄÇ`, false, true);
                    loadKnowledgeFiles(botName);
                } else {
                    throw new Error(data.message || 'Âà™Èô§Â§±Êïó');
                }
            } catch (error) {
                showMessage('Âà™Èô§Â§±Êïó: ' + error.message, true, true);
            }
        }

        // ================= Â∞çË©±Ë®òÈåÑÁÆ°ÁêÜÂäüËÉΩ =================

        // ËºâÂÖ•Â∞çË©±Ë®òÈåÑ
        async function loadConversations(page = 1, search = '') {
            if (!currentBotName) return;
            
            const listDiv = document.getElementById('conversationsList');
            const statsDiv = document.getElementById('conversationStats');
            const pageInfo = document.getElementById('pageInfo');
            
            listDiv.innerHTML = '<p>Ê≠£Âú®ËºâÂÖ•Â∞çË©±Ë®òÈåÑ...</p>';
            
            try {
                const searchParam = search ? `&search=${encodeURIComponent(search)}` : '';
                const response = await fetch(`/api/bots/${currentBotName}/conversations?page=${page}&limit=10${searchParam}`);
                if (!response.ok) throw new Error(`ËºâÂÖ•Â§±Êïó: ${response.status}`);
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'ËºâÂÖ•Â§±Êïó');
                }
                
                const conversations = data.conversations;
                allConversationsOnPage = conversations;
                currentPage = data.page;
                totalPages = data.total_pages;
                
                // Êõ¥Êñ∞Áµ±Ë®à‰ø°ÊÅØ
                statsDiv.textContent = `ÂÖ± ${data.total} Ê¢ùÂ∞çË©±Ë®òÈåÑ`;
                pageInfo.textContent = `È†ÅÈù¢ ${currentPage} / ${totalPages}`;
                
                // Êõ¥Êñ∞ÂàÜÈ†ÅÊåâÈàïÁãÄÊÖã
                document.getElementById('prevPageBtn').disabled = currentPage <= 1;
                document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
                
                if (conversations.length === 0) {
                    listDiv.innerHTML = '<p style="color:#6c757d; text-align:center; padding: 20px;">Ê≠§Ê©üÂô®‰∫∫ÈÇÑÊ≤íÊúâÂ∞çË©±Ë®òÈåÑ„ÄÇ</p>';
                    return;
                }
                
                // Âª∫Á´ãÂ∞çË©±Ë®òÈåÑË°®Ê†º
                let tableHtml = `
                    <table class="conversation-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th style="padding: 8px; text-align: center; width: 50px;">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                </th>
                                <th style="padding: 8px; text-align: left; width: 25%;">Áî®Êà∂ÂïèÈ°å</th>
                                <th style="padding: 8px; text-align: left; width: 30%;">Ê©üÂô®‰∫∫ÂõûÁ≠î</th>
                                <th style="padding: 8px; text-align: center; width: 15%;">Chunks</th>
                                <th style="padding: 8px; text-align: center; width: 12%;">ÊôÇÈñì</th>
                                <th style="padding: 8px; text-align: center; width: 13%;">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                conversations.forEach(conv => {
                    const timestamp = conv.timestamp || conv.created_at;
                    const timeStr = timestamp ? new Date(timestamp).toLocaleString('zh-TW') : 'Êú™Áü•';
                    
                    // ÁîüÊàê chunk ÊåâÈàï
                    let chunkButtons = '';
                    if (conv.chunk_ids && conv.chunk_ids.length > 0) {
                        chunkButtons = conv.chunk_ids.map((chunkIndex, idx) => 
                            `<button onclick="showChunkContent(${chunkIndex})" class="chunk-btn" title="Êü•Áúã Chunk ${chunkIndex}">${idx + 1}</button>`
                        ).join('');
                    } else {
                        chunkButtons = '<span style="color: #6c757d;">ÁÑ°</span>';
                    }
                    
                    // Ê∑ªÂä†ÁãÄÊÖãÊåáÁ§∫Âô®
                    const statusIcon = conv.error_occurred ? '‚ùå' : '‚úÖ';
                    const statusTitle = conv.error_occurred ? 'ËôïÁêÜÂ§±Êïó' : 'ËôïÁêÜÊàêÂäü';
                    const rowClass = conv.error_occurred ? 'error-row' : 'success-row';
                    
                    tableHtml += `
                        <tr class="${rowClass}" style="border-bottom: 1px solid #eee;">
                            <td style="padding: 8px; text-align: center;">
                                <input type="checkbox" value="${conv.id}" onchange="toggleConversationSelection(${conv.id})">
                            </td>
                            <td style="padding: 8px; word-break: break-word; max-width: 200px;">
                                <span title="${conv.full_user_message || conv.user_message}">${conv.user_message}</span>
                                <div class="conversation-meta">
                                    ÊúÉË©±: ${conv.session_id}
                                </div>
                            </td>
                            <td style="padding: 8px; word-break: break-word; max-width: 250px;">
                                <span title="${conv.full_bot_response || conv.bot_response}">${conv.bot_response}</span>
                                ${conv.collection_used ? `<div class="conversation-meta" style="color: #007bff;">üìö ${conv.collection_used}</div>` : ''}
                            </td>
                            <td style="padding: 8px; text-align: center;">${chunkButtons}</td>
                            <td style="padding: 8px; text-align: center; font-size: 0.9em;">
                                <div>${timeStr}</div>
                                ${conv.processing_time ? `<div class="conversation-meta">${conv.processing_time}ms</div>` : ''}
                            </td>
                            <td style="padding: 8px; text-align: center;">
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <button onclick="showConversationDetail(${conv.id})" class="btn-config" style="padding: 3px 6px; font-size: 0.8em;" title="${statusTitle}">
                                        ${statusIcon} Ë©≥ÊÉÖ
                                    </button>
                                    <button onclick="deleteConversation(${conv.id})" class="btn-delete" style="padding: 3px 6px; font-size: 0.8em;">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                listDiv.innerHTML = tableHtml;
                
                // ÈáçÁΩÆÈÅ∏ÊìáÁãÄÊÖã
                selectedConversations.clear();
                updateSelectedUI();
                
            } catch (error) {
                listDiv.innerHTML = `<p style="color:red; text-align:center; padding: 20px;">ËºâÂÖ•Â∞çË©±Ë®òÈåÑÂ§±Êïó: ${error.message}</p>`;
                statsDiv.textContent = 'ËºâÂÖ•Â§±Êïó';
            }
        }

        // ÊêúÁ¥¢Â∞çË©±
        function searchConversations() {
            const searchInput = document.getElementById('conversationSearch');
            const searchTerm = searchInput.value.trim();
            currentPage = 1;
            selectedConversations.clear();
            updateSelectedUI();
            loadConversations(currentPage, searchTerm);
        }

        // ÂàáÊèõÂñÆÂÄãÂ∞çË©±ÈÅ∏Êìá
        function toggleConversationSelection(conversationId) {
            if (selectedConversations.has(conversationId)) {
                selectedConversations.delete(conversationId);
            } else {
                selectedConversations.add(conversationId);
            }
            updateSelectedUI();
        }

        // ÂàáÊèõÂÖ®ÈÅ∏
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
            
            if (selectAllCheckbox.checked) {
                // ÂÖ®ÈÅ∏Áï∂ÂâçÈ†ÅÈù¢
                checkboxes.forEach(cb => {
                    cb.checked = true;
                    selectedConversations.add(parseInt(cb.value));
                });
            } else {
                // ÂèñÊ∂àÂÖ®ÈÅ∏
                checkboxes.forEach(cb => {
                    cb.checked = false;
                    selectedConversations.delete(parseInt(cb.value));
                });
            }
            updateSelectedUI();
        }

        // Êõ¥Êñ∞ÈÅ∏ÊìáÁãÄÊÖãUI
        function updateSelectedUI() {
            const selectedCount = selectedConversations.size;
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const countSpan = document.getElementById('selectedCount');
            const selectAllBtn = document.getElementById('selectAllBtn');
            
            countSpan.textContent = `Â∑≤ÈÅ∏‰∏≠ ${selectedCount} È†Ö`;
            deleteBtn.disabled = selectedCount === 0;
            
            // Êõ¥Êñ∞ÂÖ®ÈÅ∏ÊåâÈàïÊñáÂ≠ó
            if (selectedCount === 0) {
                selectAllBtn.textContent = '‚òëÔ∏è ÂÖ®ÈÅ∏';
            } else if (selectedCount === allConversationsOnPage.length) {
                selectAllBtn.textContent = '‚¨ú ÂèñÊ∂àÂÖ®ÈÅ∏';
            } else {
                selectAllBtn.textContent = '‚òëÔ∏è ÂÖ®ÈÅ∏';
            }
        }

        // È°ØÁ§∫ Chunk ÂÖßÂÆπ
        async function showChunkContent(chunkIndex) {
            if (!currentBotName || chunkIndex === undefined) return;
            
            const modal = document.getElementById('chunkModal');
            const title = document.getElementById('chunkModalTitle');
            const content = document.getElementById('chunkContent');
            const metadata = document.getElementById('chunkMetadata');
            
            title.textContent = `Chunk ÂÖßÂÆπ: #${chunkIndex}`;
            content.textContent = 'ËºâÂÖ•‰∏≠...';
            metadata.innerHTML = '';
            modal.style.display = 'flex';
            
            try {
                const response = await fetch(`/api/bots/${currentBotName}/conversations/chunk/${chunkIndex}`);
                if (!response.ok) throw new Error('ËºâÂÖ•Â§±Êïó');
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'ËºâÂÖ•Â§±Êïó');
                }
                
                const chunk = data.chunk;
                content.textContent = chunk.content;
                
                // È°ØÁ§∫ÂÖÉÊï∏Êìö
                const stats = chunk.content_stats || {};
                metadata.innerHTML = `
                    <h4>üìä Chunk Ë©≥Á¥∞‰ø°ÊÅØ</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <div><strong>Chunk Á¥¢Âºï:</strong> ${chunk.chunk_index}</div>
                        <div><strong>Token Êï∏Èáè:</strong> ${chunk.token_count || 'N/A'}</div>
                        <div><strong>ÊñáÂ≠óÈ°ûÂûã:</strong> ${chunk.text_type || 'N/A'}</div>
                        <div><strong>ÂìÅË≥™ÂàÜÊï∏:</strong> ${chunk.quality_score || 'N/A'}</div>
                        <div><strong>Â≠óÁ¨¶Êï∏:</strong> ${stats.total_chars || 'N/A'}</div>
                        <div><strong>Ë°åÊï∏:</strong> ${stats.total_lines || 'N/A'}</div>
                        <div><strong>Ë©ûÊï∏:</strong> ${stats.total_words || 'N/A'}</div>
                        <div><strong>Âè•Êï∏:</strong> ${stats.total_sentences || 'N/A'}</div>
                        <div><strong>‰æÜÊ∫êÊñá‰ª∂:</strong> ${chunk.original_filename || chunk.source_file || 'N/A'}</div>
                        <div><strong>Ë™ûË®Ä:</strong> ${chunk.language || 'N/A'}</div>
                        <div><strong>ËôïÁêÜÁ≠ñÁï•:</strong> ${chunk.processing_strategy || 'N/A'}</div>
                        <div><strong>ÂàÜÂâ≤ÊñπÊ≥ï:</strong> ${chunk.split_method || 'N/A'}</div>
                    </div>
                `;
                
            } catch (error) {
                content.textContent = `ËºâÂÖ• Chunk ÂÖßÂÆπÂ§±Êïó: ${error.message}`;
                metadata.innerHTML = '';
            }
        }

        // È°ØÁ§∫Â∞çË©±Ë©≥ÊÉÖ
        function showConversationDetail(conversationId) {
            const conversation = allConversationsOnPage.find(conv => conv.id === conversationId);
            if (!conversation) return;

            const modal = document.getElementById('conversationDetailModal');
            const content = document.getElementById('conversationDetailContent');

            const timestamp = conversation.timestamp || conversation.created_at;
            const timeStr = timestamp ? new Date(timestamp).toLocaleString('zh-TW') : 'Êú™Áü•';
            
            content.innerHTML = `
                <div class="info-card">
                    <h4>üìä Â∞çË©±Âü∫Êú¨‰ø°ÊÅØ</h4>
                    <div class="info-row">
                        <span class="info-label">Â∞çË©±ID:</span>
                        <span class="info-value">${conversation.id}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ÊúÉË©±ID:</span>
                        <span class="info-value">${conversation.session_id}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ÊôÇÈñì:</span>
                        <span class="info-value">${timeStr}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ËôïÁêÜÊôÇÈñì:</span>
                        <span class="info-value">${conversation.processing_time || 0}ms</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">‰ΩøÁî®ÈõÜÂêà:</span>
                        <span class="info-value">${conversation.collection_used || 'ÁÑ°'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ÁãÄÊÖã:</span>
                        <span class="info-value">${conversation.error_occurred ? '‚ùå ËôïÁêÜÂ§±Êïó' : '‚úÖ ËôïÁêÜÊàêÂäü'}</span>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4>‚ùì Áî®Êà∂ÂïèÈ°å</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff;">
                        ${conversation.full_user_message || conversation.user_message}
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4>ü§ñ Ê©üÂô®‰∫∫ÂõûÁ≠î</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #28a745;">
                        ${conversation.full_bot_response || conversation.bot_response}
                    </div>
                </div>

                ${conversation.chunk_ids && conversation.chunk_ids.length > 0 ? `
                <div>
                    <h4>üìö Áõ∏Èóú Chunks</h4>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        ${conversation.chunk_ids.map((chunkIndex, idx) => 
                            `<button onclick="showChunkContent(${chunkIndex})" class="chunk-btn">Chunk ${idx + 1}</button>`
                        ).join('')}
                    </div>
                </div>
                ` : ''}
            `;

            modal.style.display = 'flex';
        }

        // Âà™Èô§ÂñÆÊ¢ùÂ∞çË©±Ë®òÈåÑ
        async function deleteConversation(conversationId) {
            if (!currentBotName || !conversationId) return;
            
            if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÊ¢ùÂ∞çË©±Ë®òÈåÑÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÊí§Èä∑„ÄÇ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/bots/${currentBotName}/conversations/${conversationId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showMessage('Â∞çË©±Ë®òÈåÑÂ∑≤Âà™Èô§', false, true);
                    loadConversations(currentPage);
                } else {
                    throw new Error(data.message || 'Âà™Èô§Â§±Êïó');
                }
            } catch (error) {
                showMessage('Âà™Èô§Â∞çË©±Ë®òÈåÑÂ§±Êïó: ' + error.message, true, true);
            }
        }

        // ÊâπÈáèÂà™Èô§Â∞çË©±Ë®òÈåÑ
        async function deleteSelectedConversations() {
            if (selectedConversations.size === 0) return;
            
            if (!confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÅ∏‰∏≠ÁöÑ ${selectedConversations.size} Ê¢ùÂ∞çË©±Ë®òÈåÑÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÊí§Èä∑„ÄÇ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/bots/${currentBotName}/conversations`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        conversation_ids: Array.from(selectedConversations) 
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showMessage(data.message, false, true);
                    selectedConversations.clear();
                    updateSelectedUI();
                    loadConversations(currentPage);
                } else {
                    throw new Error(data.message || 'ÊâπÈáèÂà™Èô§Â§±Êïó');
                }
            } catch (error) {
                showMessage('ÊâπÈáèÂà™Èô§Â§±Êïó: ' + error.message, true, true);
            }
        }

        // ÈóúÈñâÂêÑÁ®Æ Modal
        function closeChunkModal() {
            document.getElementById('chunkModal').style.display = 'none';
        }

        function closeConversationDetailModal() {
            document.getElementById('conversationDetailModal').style.display = 'none';
        }

        // Âà™Èô§Ê©üÂô®‰∫∫Á¢∫Ë™ç
        async function deleteBotConfirm() {
            if (!currentBotName) return;
            
            if (!confirm(`‚ö†Ô∏è Á¢∫ÂÆöË¶ÅÂÆåÂÖ®Âà™Èô§Ê©üÂô®‰∫∫ "${currentBotName}" ÂóéÔºü\n\nÈÄôÂ∞áÊúÉÂà™Èô§Ôºö\n‚Ä¢ Ê©üÂô®‰∫∫ÈÖçÁΩÆ\n‚Ä¢ ÊâÄÊúâÁü•Ë≠òÂ∫´Êñá‰ª∂\n‚Ä¢ Â∞çË©±Ë®òÈåÑ\n\nÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÊí§Èä∑ÔºÅ`)) {
                return;
            }

            try {
                const response = await fetch(`/api/bots/${currentBotName}`, { method: 'DELETE' });
                const data = await response.json();
                if (response.ok) {
                    showMessage(`Ê©üÂô®‰∫∫ ${currentBotName} Â∑≤ÂÆåÂÖ®Âà™Èô§`);
                    showMainPage();
                } else {
                    throw new Error(data.detail || data.message);
                }
            } catch (error) {
                showMessage('Âà™Èô§Â§±Êïó: ' + error.message, true);
            }
        }

        // È†ÅÈù¢ËºâÂÖ•ÂíåÂÆöÊúüÂà∑Êñ∞
        document.addEventListener('DOMContentLoaded', () => {
            fetchBots();
            setupDisplayNameValidation(); // ÂàùÂßãÂåñÈ°ØÁ§∫ÂêçÁ®±È©óË≠â
            // ÊØè10ÁßíÂà∑Êñ∞‰∏ÄÊ¨°ÂàóË°®ÔºàÂÉÖÂú®‰∏ªÈ†ÅÈù¢ÊôÇÔºâ
            setInterval(() => {
                if (document.getElementById('mainPage').classList.contains('active')) {
                    fetchBots();
                }
            }, 10000);
        });

        // ÈªûÊìä Modal Â§ñÈÉ®ÈóúÈñâ
        document.getElementById('chunkModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('chunkModal')) {
                closeChunkModal();
            }
        });

        document.getElementById('conversationDetailModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('conversationDetailModal')) {
                closeConversationDetailModal();
            }
        });

        // ÊêúÁ¥¢Ê°Ü Enter ÈçµÊîØÊè¥
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const activeElement = document.activeElement;
                if (activeElement && activeElement.id === 'conversationSearch') {
                    searchConversations();
                }
            }
        });

        // ÁÄèË¶ΩÂô®ÂâçÈÄ≤ÂæåÈÄÄÊåâÈçµÊîØÊè¥
        window.addEventListener('popstate', (e) => {
            if (e.state && e.state.page === 'manage') {
                showManagePage(e.state.botName);
            } else {
                showMainPage();
            }
        });

        // Êõ¥Êñ∞ showManagePage ÂáΩÊï∏‰ª•ÊîØÊè¥ÁÄèË¶ΩÂô®Ê≠∑Âè≤
        function showManagePageWithHistory(botName) {
            history.pushState({page: 'manage', botName: botName}, '', `#manage-${botName}`);
            showManagePage(botName);
        }

        // Êõ¥Êñ∞ showMainPage ÂáΩÊï∏‰ª•ÊîØÊè¥ÁÄèË¶ΩÂô®Ê≠∑Âè≤
        function showMainPageWithHistory() {
            history.pushState({page: 'main'}, '', '#main');
            showMainPage();
        }
    </script>
</body>
</html>