<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©æ©Ÿå™¨äººæœå‹™ç®¡ç†å™¨</title>
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f4f4f9; }
        h1, h2 { color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .bot-list, .create-bot { margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #e9ecef; }
        button { cursor: pointer; padding: 8px 12px; border-radius: 4px; border: none; color: white; margin: 2px; }
        .btn-start { background-color: #28a745; }
        .btn-stop { background-color: #dc3545; }
        .btn-config { background-color: #007bff; }
        .btn-edit { background-color: #17a2b8; }
        .btn-delete { background-color: #dc3545; }
        .btn-save { background-color: #28a745; }
        .btn-cancel { background-color: #6c757d; }
        .btn-logout { background-color: #6c757d; }
        .btn-back { background-color: #6c757d; padding: 10px 20px; text-decoration: none; color: white; border-radius: 4px; display: inline-block; margin-bottom: 20px; }
        .status-running { color: #28a745; font-weight: bold; }
        .status-stopped { color: #6c757d; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select { width: 95%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        .form-group textarea { height: 100px; resize: vertical; }
        #message { margin-top: 15px; padding: 10px; border-radius: 4px; display: none; }
        .msg-success { background-color: #d4edda; color: #155724; }
        .msg-error { background-color: #f8d7da; color: #721c24; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* é é¢åˆ‡æ›æ¨£å¼ */
        .page { display: none; }
        .page.active { display: block; }
        
        /* æ¨™ç±¤é æ¨£å¼ */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            margin-right: 2px;
            color: #495057;
        }
        .tab.active {
            background: white;
            border-bottom-color: #007bff;
            color: #007bff;
        }
        .tab:hover {
            background: #e9ecef;
            color: #007bff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* è©³ç´°ä¿¡æ¯å¡ç‰‡ */
        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .info-card h4 {
            margin-top: 0;
            color: #495057;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .info-label {
            font-weight: bold;
            color: #6c757d;
        }
        .info-value {
            color: #495057;
        }
        
        /* è¡¨æ ¼æ“ä½œæŒ‰éˆ•çµ„ */
        .btn-group {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        /* ç‹€æ…‹å¾½ç«  */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .status-running {
            background-color: #d4edda;
            color: #155724;
        }
        .status-stopped {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* å°è©±è¨˜éŒ„å°ˆç”¨æ¨£å¼ */
        .conversation-table {
            font-size: 0.9em;
        }
        .conversation-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            text-align: center;
        }
        .conversation-table td {
            vertical-align: top;
        }
        .chunk-btn {
            padding: 2px 6px;
            margin: 1px;
            font-size: 0.8em;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .chunk-btn:hover {
            background-color: #138496;
        }
        .conversation-meta {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 4px;
        }
        .error-row {
            background-color: #fff5f5 !important;
        }
        .success-row {
            background-color: #f8fff8;
        }

        /* é¡¯ç¤ºåç¨±ç›¸é—œæ¨£å¼ */
        .display-name-group {
            background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
            border: 1px solid #e1f5fe;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .display-name-group h4 {
            margin: 0 0 15px 0;
            color: #1976d2;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .field-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .field-indicator.user-visible {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .field-indicator.system-internal {
            background-color: #f5f5f5;
            color: #6c757d;
        }

        /* æ©Ÿå™¨äººåç¨±é¡¯ç¤ºæ¨£å¼ */
        .bot-name-display {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .bot-display-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bot-tech-name {
            font-size: 0.85em;
            color: #6c757d;
            font-weight: normal;
        }

        .bot-tech-name::before {
            content: "âš™ï¸";
            margin-right: 4px;
        }

        /* å­—ç¬¦è¨ˆæ•¸å™¨ */
        .char-counter {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            color: #6c757d;
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .char-counter.warning {
            color: #fd7e14;
        }

        .char-counter.danger {
            color: #dc3545;
        }

        /* è¡¨å–®é©—è­‰æ¨£å¼ */
        .form-group.has-validation .form-control:invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .form-group.has-validation .form-control:valid {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .validation-message {
            font-size: 0.875em;
            margin-top: 5px;
            padding: 4px 0;
        }

        .validation-message.error {
            color: #dc3545;
        }

        .validation-message.success {
            color: #28a745;
        }

        /* Modal æ¨£å¼ï¼ˆåƒ…ç”¨æ–¼ Chunk è©³æƒ…ç­‰è¼”åŠ©åŠŸèƒ½ï¼‰ */
        .modal {
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            justify-content: center; 
            align-items: center; 
            z-index: 1000;
        }
        .modal-content {
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            width: 90%; 
            max-width: 800px; 
            max-height: 90vh; 
            overflow-y: auto;
        }

        /* å¤§å‹ Modal æ¨£å¼ */
        .large-modal .modal-content {
            max-width: 1000px;
            width: 95%;
        }

        /* ğŸ†• çŸ¥è­˜åº«çµ±è¨ˆä¿¡æ¯æ¨£å¼ */
        .knowledge-stats {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border: 1px solid #c3e6c3;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .knowledge-stats .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9em;
        }

        .knowledge-stats .stat-label {
            color: #2d5a2d;
            font-weight: 600;
        }

        .knowledge-stats .stat-value {
            color: #1a4d1a;
            font-weight: bold;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container { margin: 1em; padding: 15px; }
            table { font-size: 0.9em; }
            .btn-group { flex-direction: column; }
            .conversation-table { font-size: 0.8em; }
            .tabs { flex-wrap: wrap; }
            .tab { font-size: 0.9em; padding: 8px 12px; }

            .display-name-group {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .bot-display-name {
                font-size: 1em;
            }
            
            .bot-tech-name {
                font-size: 0.8em;
            }
            
            .field-indicator {
                font-size: 0.75em;
                padding: 1px 6px;
            }

            .knowledge-stats {
                flex-direction: column;
                align-items: flex-start;
            }
        }
            /* æ”¹å–„çš„æ¨£å¼ */
            .form-group details summary {
                padding: 4px 8px;
                border-radius: 4px;
                background: #e9ecef;
                display: inline-block;
            }

            .form-group details summary:hover {
                background: #dee2e6;
            }

            .form-group details[open] summary {
                background: #007bff;
                color: white;
            }

            /* æ‹–æ”¾å€åŸŸæ¨£å¼ï¼ˆå¯é¸å¢å¼·åŠŸèƒ½ï¼‰ */
            .drop-zone {
                border: 2px dashed #dee2e6;
                border-radius: 8px;
                padding: 20px;
                text-align: center;
                background: #f8f9fa;
                transition: all 0.3s ease;
                margin-top: 10px;
            }

            .drop-zone.drag-over {
                border-color: #007bff;
                background: #e3f2fd;
            }

            .drop-zone p {
                margin: 0;
                color: #6c757d;
                font-size: 0.9em;
            }

    </style>
</head>
<body>
    <!-- ä¸»åˆ—è¡¨é é¢ -->
    <div id="mainPage" class="page active">
        <div class="container">
            <!-- æ¨™é¡Œå’Œç™»å‡º -->
            <div class="header">
                <h1>ğŸ¤– èŠå¤©æ©Ÿå™¨äººæœå‹™ç®¡ç†å™¨</h1>
                <button onclick="logout()" class="btn-logout">ç™»å‡º</button>
            </div>
            
            <!-- å‰µå»ºæ–°æ©Ÿå™¨äºº -->
            <div class="create-bot">
                <h2>å‰µå»ºæ–°æ©Ÿå™¨äºº</h2>
                <div class="display-name-group">
                    <h4>ğŸ¯ æ©Ÿå™¨äººå‘½åè¨­å®š</h4>
                    <form id="createBotForm">
                        <!-- é¡¯ç¤ºåç¨±æ¬„ä½ -->
                        <div class="form-group">
                            <label for="botDisplayName">
                                æ©Ÿå™¨äººé¡¯ç¤ºåç¨± 
                                <span class="field-indicator user-visible">ğŸ‘€ ç”¨æˆ¶å¯è¦‹</span>
                            </label>
                            <input type="text" id="botDisplayName" required maxlength="50" placeholder="ä¾‹å¦‚: æ™ºèƒ½è²¡å‹™é¡§å•">
                            <small style="color: #6c757d;">é€™å€‹åç¨±æœƒé¡¯ç¤ºåœ¨èŠå¤©ç•Œé¢é ‚éƒ¨ï¼Œè®“ç”¨æˆ¶æ›´å®¹æ˜“ç†è§£æ©Ÿå™¨äººçš„åŠŸèƒ½</small>
                        </div>
                        
                        <!-- æŠ€è¡“åç¨±æ¬„ä½ -->
                        <div class="form-group">
                            <label for="botName">
                                æ©Ÿå™¨äººæŠ€è¡“åç¨± 
                                <span class="field-indicator system-internal">âš™ï¸ ç³»çµ±å…§éƒ¨</span>
                            </label>
                            <input type="text" id="botName" required pattern="[a-z0-9-_]+" placeholder="ä¾‹å¦‚: finance-bot">
                            <small style="color: #6c757d;">è‹±æ–‡ã€æ•¸å­—ã€é€£å­—ç¬¦ï¼Œç”¨æ–¼ç³»çµ±å…§éƒ¨è­˜åˆ¥ï¼Œå‰µå»ºå¾Œä¸å¯ä¿®æ”¹</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="botPort">æœå‹™ç«¯å£ (ä¾‹å¦‚: 8002)</label>
                            <input type="number" id="botPort" required min="1025" max="65535" placeholder="8002">
                        </div>
                        <div class="form-group">
                            <label for="systemRole">ç³»çµ±è§’è‰²</label>
                            <textarea id="systemRole" rows="3" placeholder="æè¿°é€™å€‹æ©Ÿå™¨äººçš„è§’è‰²å’ŒåŠŸèƒ½..."></textarea>
                        </div>
                        <button type="submit" class="btn-config">ğŸš€ å‰µå»ºæ©Ÿå™¨äºº</button>
                    </form>
                </div>
            </div>

            <!-- æ©Ÿå™¨äººåˆ—è¡¨ -->
            <div class="bot-list">
                <h2>æ©Ÿå™¨äººå¯¦ä¾‹åˆ—è¡¨</h2>
                <table id="botTable">
                    <thead>
                        <tr>
                            <th>æ©Ÿå™¨äººåç¨±</th>
                            <th>ç‹€æ…‹</th>
                            <th>ç«¯å£</th>
                            <th>ç³»çµ±è§’è‰²</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="botTableBody">
                        <!-- JS å‹•æ…‹å¡«å…¥ -->
                    </tbody>
                </table>
            </div>

            <div id="message"></div>
        </div>
    </div>

    <!-- æ©Ÿå™¨äººç®¡ç†é é¢ -->
    <div id="managePage" class="page">
        <div class="container">
            <!-- é ‚éƒ¨å°èˆª -->
            <div class="header">
                <div>
                    <a href="#" onclick="showMainPage()" class="btn-back">â† è¿”å›åˆ—è¡¨</a>
                    <h1 id="managePageTitle">ç®¡ç†æ©Ÿå™¨äºº</h1>
                </div>
                <button onclick="logout()" class="btn-logout">ç™»å‡º</button>
            </div>
            
            <!-- æ¨™ç±¤é  -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('info')">ğŸ“Š åŸºæœ¬ä¿¡æ¯</button>
                <button class="tab" onclick="switchTab('config')">âš™ï¸ é…ç½®è¨­å®š</button>
                <button class="tab" onclick="switchTab('knowledge')">ğŸ“š çŸ¥è­˜åº«</button>
                <button class="tab" onclick="switchTab('conversations')">ğŸ’¬ å°è©±è¨˜éŒ„</button>
            </div>

            <!-- åŸºæœ¬ä¿¡æ¯æ¨™ç±¤ -->
            <div id="infoTab" class="tab-content active">
                <div class="info-card">
                    <h4>ğŸ“‹ æ©Ÿå™¨äººåŸºæœ¬ä¿¡æ¯</h4>
                    <div id="botInfoDetails">
                        <!-- JS å‹•æ…‹å¡«å…¥ -->
                    </div>
                </div>
            </div>

            <!-- é…ç½®è¨­å®šæ¨™ç±¤ -->
            <div id="configTab" class="tab-content">
                <form id="editBotForm">
                    <!-- é¡¯ç¤ºåç¨±ç·¨è¼¯æ¬„ä½ -->
                    <div class="form-group">
                        <label for="editDisplayName">
                            æ©Ÿå™¨äººé¡¯ç¤ºåç¨±
                            <span class="field-indicator user-visible">ğŸ‘€ ç”¨æˆ¶å¯è¦‹</span>
                        </label>
                        <input type="text" class="form-control" id="editDisplayName" maxlength="50" placeholder="ç”¨æˆ¶çœ‹åˆ°çš„æ©Ÿå™¨äººåç¨±">
                        <small style="color: #6c757d;">æœ€å¤š50å€‹å­—ç¬¦ï¼Œé€™å€‹åç¨±æœƒé¡¯ç¤ºåœ¨èŠå¤©ç•Œé¢é ‚éƒ¨</small>
                    </div>

                    <div class="form-group">
                        <label for="editSystemRole">ç³»çµ±è§’è‰² (System Role)</label>
                        <textarea class="form-control" id="editSystemRole" rows="4"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="editTemperature">æº«åº¦ (Temperature)</label>
                            <input type="number" class="form-control" id="editTemperature" step="0.1" min="0" max="1">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="editMaxTokens">æœ€å¤§æ¬Šæ– (Max Tokens)</label>
                            <input type="number" class="form-control" id="editMaxTokens" step="100" min="100">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="editDynamicRecommendations">
                            <label class="custom-control-label" for="editDynamicRecommendations">å•Ÿç”¨ LLM å‹•æ…‹æ¨è–¦å•é¡Œ</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editDynamicRecommendationsCount">æ¨è–¦å•é¡Œç”Ÿæ•ˆæ¬¡æ•¸ (0ç‚ºç„¡é™)</label>
                        <input type="number" class="form-control" id="editDynamicRecommendationsCount" min="0">
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="editCiteSources">
                            <label class="custom-control-label" for="editCiteSources">å•Ÿç”¨å¼•ç”¨è³‡æ–™ä¾†æºç¶²å€</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editPort">æœå‹™ç«¯å£</label>
                        <input type="number" id="editPort" min="1025" max="65535" placeholder="8002">
                        <small style="color: #6c757d;">âš ï¸ ä¿®æ”¹ç«¯å£éœ€è¦é‡å•Ÿæ©Ÿå™¨äºº</small>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn-save">ğŸ’¾ ä¿å­˜é…ç½®</button>
                        <button type="button" class="btn-cancel" onclick="loadBotConfig()">ğŸ”„ é‡ç½®</button>
                    </div>
                </form>
            </div>

            <!-- çŸ¥è­˜åº«æ¨™ç±¤ -->
            <div id="knowledgeTab" class="tab-content">
                <h4>ğŸ“ çŸ¥è­˜åº«æ–‡ä»¶ç®¡ç†</h4>
                
                <!-- ğŸ†• çŸ¥è­˜åº«çµ±è¨ˆä¿¡æ¯ -->
                <div id="knowledgeStats" class="knowledge-stats" style="display: none;">
                    <div class="stat-item">
                        <span class="stat-label">ğŸ“„ æ–‡ä»¶ç¸½æ•¸:</span>
                        <span class="stat-value" id="totalFilesCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ğŸ§© ç¸½ Chunks:</span>
                        <span class="stat-value" id="totalChunksCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ğŸ“Š ç‹€æ…‹:</span>
                        <span class="stat-value" id="knowledgeStatus">å°±ç·’</span>
                    </div>
                </div>
                <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="knowledgeSearch" placeholder="æœç´¢æ–‡ä»¶å..." style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px;">
        <button onclick="searchKnowledgeFiles()" class="btn-config">ğŸ” æœç´¢</button>
        <button onclick="loadKnowledgeFiles(currentBotName, 1)" class="btn-config">ğŸ”„ é‡ç½®</button>
    </div>
    <div>
        <span id="knowledgePageStats">è¼‰å…¥ä¸­...</span>
    </div>
</div>

<!-- ğŸ†• åˆ†é æ§åˆ¶å€åŸŸ -->
<div style="margin-bottom: 15px; display: flex; justify-content: center; align-items: center; gap: 10px;">
    <button id="knowledgePrevBtn" onclick="loadKnowledgeFiles(currentBotName, knowledgeCurrentPage - 1)" class="btn-config" disabled>â¬…ï¸ ä¸Šä¸€é </button>
    <span id="knowledgePageInfo" style="margin: 0 15px;">é é¢ 1</span>
    <button id="knowledgeNextBtn" onclick="loadKnowledgeFiles(currentBotName, knowledgeCurrentPage + 1)" class="btn-config" disabled>ä¸‹ä¸€é  â¡ï¸</button>
    
    <select id="knowledgePageSize" onchange="changeKnowledgePageSize()" style="margin-left: 15px; padding: 4px;">
        <option value="10">æ¯é  10 é …</option>
        <option value="20" selected>æ¯é  20 é …</option>
        <option value="50">æ¯é  50 é …</option>
        <option value="100">æ¯é  100 é …</option>
    </select>
</div>
                <!-- æ–‡ä»¶åˆ—è¡¨è¡¨æ ¼ -->
                <div id="knowledgeFilesList" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                    <!-- JS å‹•æ…‹å¡«å…¥ -->
                </div>

                <div class="form-group">
                <label for="fileUpload">ä¸Šå‚³æ–°æ–‡ä»¶ (æ”¯æŒ .txt, .pdf, .docx, .doc, .md, .csv, .json, .epub, .py, .js, .rst, .org)</label>
                <input type="file" id="fileUpload" accept=".txt,.pdf,.docx,.doc,.md,.csv,.json,.epub,.py,.js,.rst,.org" multiple>
                <button id="uploadBtn" onclick="uploadFile()" class="btn-config" style="margin-top:10px;">
                    <span id="uploadIcon">ğŸ“¤</span> ä¸Šå‚³æ–‡ä»¶
                </button>
                <span id="uploadStatus" style="margin-left: 15px; color: #007bff; font-weight: bold;"></span>
                
                <!-- æ·»åŠ æ–‡ä»¶æ ¼å¼èªªæ˜ -->
                <div style="margin-top: 8px; font-size: 0.85em; color: #6c757d;">
                    <details>
                        <summary style="cursor: pointer; user-select: none;">ğŸ“ æ”¯æŒçš„æ–‡ä»¶æ ¼å¼è©³ç´°èªªæ˜</summary>
                        <div style="margin-top: 8px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
                                <div><strong>æ–‡æª”é¡å‹:</strong> .txt, .md, .rst, .org</div>
                                <div><strong>PDFæ–‡æª”:</strong> .pdf</div>
                                <div><strong>Wordæ–‡æª”:</strong> .docx, .doc</div>
                                <div><strong>æ•¸æ“šæ–‡ä»¶:</strong> .csv, .json</div>
                                <div><strong>ä»£ç¢¼æ–‡ä»¶:</strong> .py, .js</div>
                                <div><strong>é›»å­æ›¸:</strong> .epub</div>
                            </div>
                            <div style="margin-top: 8px; font-size: 0.8em; color: #495057;">
                                ğŸ’¡ ç³»çµ±æœƒè‡ªå‹•æª¢æ¸¬æ–‡ä»¶ç·¨ç¢¼ä¸¦é€²è¡Œæ™ºèƒ½åˆ†å¡Šè™•ç†ï¼Œæ”¯æŒä¸­è‹±æ–‡æ··åˆå…§å®¹ã€‚
                            </div>
                        </div>
                    </details>
                </div>
            </div>

                        <!-- ğŸš¨ ç·Šæ€¥æ“ä½œå€åŸŸ -->
        <div style="margin-top: 30px; padding: 15px; border: 2px solid #dc3545; border-radius: 8px; background-color: #fff5f5;">
            <h4 style="color: #dc3545; margin-top: 0;">ğŸš¨ ç·Šæ€¥æ“ä½œå€åŸŸ</h4>
            <p style="color: #6c757d; margin-bottom: 15px;">
                <strong>è­¦å‘Šï¼š</strong>ä»¥ä¸‹æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ•¸æ“šï¼Œè«‹è¬¹æ…ä½¿ç”¨ï¼
            </p>
            
            <!-- é›†åˆç‹€æ…‹æŸ¥çœ‹ -->
            <div style="margin-bottom: 15px;">
                <button onclick="checkCollectionsStatus()" class="btn-config" style="background-color: #17a2b8;">
                    ğŸ“Š æŸ¥çœ‹é›†åˆç‹€æ…‹
                </button>
                <div id="collectionsStatus" style="margin-top: 10px; display: none;"></div>
            </div>
            
            <!-- test_01 ç·Šæ€¥æ¸…ç©º -->
            <div style="margin-bottom: 15px;">
                <button onclick="emergencyClearTest01()" class="btn-delete" style="background-color: #dc3545;">
                    ğŸ—‘ï¸ ç·Šæ€¥æ¸…ç©º test_01
                </button>
                <span style="margin-left: 10px; color: #dc3545; font-size: 0.9em;">
                    æ­¤æ“ä½œå°‡åˆªé™¤ test_01 çš„æ‰€æœ‰å‘é‡æ•¸æ“š
                </span>
            </div>
            
            <!-- æ“ä½œçµæœé¡¯ç¤º -->
            <div id="emergencyResults" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
        </div>


        </div>

        <!-- å°è©±è¨˜éŒ„æ¨™ç±¤ -->
            <div id="conversationsTab" class="tab-content">
                <h4>ğŸ’¬ å°è©±è¨˜éŒ„ç®¡ç†</h4>
                
                <!-- æœç´¢å’Œæ§åˆ¶å€åŸŸ -->
                <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="conversationSearch" placeholder="æœç´¢å°è©±å…§å®¹..." style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px;">
                        <button onclick="searchConversations()" class="btn-config">ğŸ” æœç´¢</button>
                        <button onclick="loadConversations(1)" class="btn-config">ğŸ”„ é‡ç½®</button>
                    </div>
                    <div>
                        <span id="conversationStats">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
                
                <!-- æ‰¹é‡æ“ä½œå€åŸŸ -->
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                    <button onclick="toggleSelectAll()" class="btn-config" id="selectAllBtn">â˜‘ï¸ å…¨é¸</button>
                    <button onclick="deleteSelectedConversations()" class="btn-delete" id="deleteSelectedBtn" disabled>ğŸ—‘ï¸ åˆªé™¤é¸ä¸­</button>
                    <span id="selectedCount" style="color: #6c757d; margin-left: 10px;">å·²é¸ä¸­ 0 é …</span>
                </div>
                
                <!-- åˆ†é æ§åˆ¶ -->
                <div style="margin-bottom: 15px; display: flex; justify-content: center; align-items: center; gap: 10px;">
                    <button id="prevPageBtn" onclick="loadConversations(currentPage - 1)" class="btn-config" disabled>â¬…ï¸ ä¸Šä¸€é </button>
                    <span id="pageInfo" style="margin: 0 15px;">é é¢ 1</span>
                    <button id="nextPageBtn" onclick="loadConversations(currentPage + 1)" class="btn-config" disabled>ä¸‹ä¸€é  â¡ï¸</button>
                </div>
                
                <!-- å°è©±è¨˜éŒ„åˆ—è¡¨ -->
                <div id="conversationsList" style="max-height: 600px; overflow-y: auto;">
                    <!-- JS å‹•æ…‹å¡«å…¥ -->
                </div>
            </div>

            <!-- é é¢åº•éƒ¨æ“ä½œæŒ‰éˆ• -->
            <hr style="margin-top: 30px;">
            
            <!-- é é¢å…§è¨Šæ¯é¡¯ç¤ºå€åŸŸ -->
            <div id="pageMessage" style="margin: 15px 0; padding: 10px; border-radius: 4px; display: none;"></div>
            
            <div class="btn-group">
                <button onclick="showMainPage()" class="btn-cancel">â† è¿”å›åˆ—è¡¨</button>
                <button onclick="deleteBotConfirm()" class="btn-delete">ğŸ—‘ï¸ åˆªé™¤æ©Ÿå™¨äºº</button>
            </div>
        </div>
    </div>

    <!-- Chunk å…§å®¹ Modal -->
    <div id="chunkModal" class="modal large-modal">
        <div class="modal-content">
            <h3 id="chunkModalTitle">Chunk å…§å®¹è©³æƒ…</h3>
            
            <!-- Chunk å…ƒæ•¸æ“š -->
            <div id="chunkMetadata" style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 5px;"></div>
            
            <!-- Chunk å…§å®¹ -->
            <div style="margin-bottom: 15px;">
                <h4>ğŸ“„ å…§å®¹</h4>
                <div id="chunkContent" style="background: white; padding: 15px; border: 1px solid #ddd; border-radius: 5px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4;"></div>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="closeChunkModal()" class="btn-cancel">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- å°è©±è©³æƒ… Modal -->
    <div id="conversationDetailModal" class="modal large-modal">
        <div class="modal-content">
            <h3>ğŸ’¬ å°è©±è©³æƒ…</h3>
            
            <div id="conversationDetailContent">
                <!-- JS å‹•æ…‹å¡«å…¥ -->
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="closeConversationDetailModal()" class="btn-cancel">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script>
    // âœ… æ–°å¢ï¼šå®‰å…¨çš„ HTML è½‰ç¾©å‡½æ•¸ï¼ˆæ”¾åœ¨ script é–‹é ­ï¼‰
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // âœ… æ–°å¢ï¼šå®‰å…¨çš„æª”æ¡ˆåç·¨ç¢¼å‡½æ•¸
        function safeEncodeFilename(filename) {
            return encodeURIComponent(filename);
        }

        // ğŸ†• ä¿®æ”¹1: æ–°å¢åˆ†é ç›¸é—œè®Šæ•¸ - æ·»åŠ åˆ°ç¾æœ‰è®Šæ•¸è²æ˜å€åŸŸ
        let knowledgeCurrentPage = 1;
        let knowledgeTotalPages = 1; 
        let knowledgePageSize = 20;
        let knowledgeSearchTerm = '';

        const createBotForm = document.getElementById('createBotForm');
        const editBotForm = document.getElementById('editBotForm');
        const botTableBody = document.getElementById('botTableBody');
        const messageDiv = document.getElementById('message');
        const pageMessageDiv = document.getElementById('pageMessage');
        let currentBotName = null;
        let currentBotConfig = null;

        // å°è©±è¨˜éŒ„ç›¸é—œè®Šæ•¸
        let currentPage = 1;
        let totalPages = 1;
        let selectedConversations = new Set();
        let allConversationsOnPage = [];

        // é é¢åˆ‡æ›åŠŸèƒ½
        function showMainPage() {
            document.getElementById('mainPage').classList.add('active');
            document.getElementById('managePage').classList.remove('active');
            currentBotName = null;
            currentBotConfig = null;
            fetchBots(); // åˆ·æ–°åˆ—è¡¨
        }

        function showManagePage(botName) {
            currentBotName = botName;
            document.getElementById('mainPage').classList.remove('active');
            document.getElementById('managePage').classList.add('active');
            document.getElementById('managePageTitle').textContent = `ç®¡ç†æ©Ÿå™¨äºº: ${botName}`;
            
            // åˆ‡æ›åˆ°ç¬¬ä¸€å€‹æ¨™ç±¤ä¸¦è¼‰å…¥é…ç½®
            switchTab('info');
            loadBotConfig();
        }

        // é¡¯ç¤ºè¨Šæ¯å‡½æ•¸
        function showMessage(message, isError = false, inPage = false) {
            const targetDiv = inPage ? pageMessageDiv : messageDiv;
            targetDiv.textContent = message;
            targetDiv.className = isError ? 'msg-error' : 'msg-success';
            targetDiv.style.display = 'block';
            setTimeout(() => { targetDiv.style.display = 'none'; }, 5000);
        }

        // é¡¯ç¤ºåç¨±é©—è­‰å’Œå­—ç¬¦è¨ˆæ•¸åŠŸèƒ½
        function setupDisplayNameValidation() {
            const displayNameInputs = ['botDisplayName', 'editDisplayName'];
            
            displayNameInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (!input) return;
                
                // å‰µå»ºå­—ç¬¦è¨ˆæ•¸å™¨
                const counter = document.createElement('span');
                counter.className = 'char-counter';
                input.parentElement.style.position = 'relative';
                input.parentElement.appendChild(counter);
                
                // æ·»åŠ é©—è­‰æ¶ˆæ¯å®¹å™¨
                const validationMsg = document.createElement('div');
                validationMsg.className = 'validation-message';
                input.parentElement.appendChild(validationMsg);
                
                // å¯¦æ™‚é©—è­‰
                input.addEventListener('input', function() {
                    const length = this.value.length;
                    const maxLength = 50;
                    
                    // æ›´æ–°è¨ˆæ•¸å™¨
                    counter.textContent = `${length}/${maxLength}`;
                    counter.className = 'char-counter';
                    
                    if (length > maxLength * 0.8) {
                        counter.classList.add('warning');
                    }
                    if (length >= maxLength) {
                        counter.classList.add('danger');
                    }
                    
                    // é©—è­‰æ¶ˆæ¯
                    if (length === 0) {
                        validationMsg.textContent = 'è«‹è¼¸å…¥é¡¯ç¤ºåç¨±';
                        validationMsg.className = 'validation-message error';
                        this.parentElement.classList.add('has-validation');
                    } else if (length > maxLength) {
                        validationMsg.textContent = 'é¡¯ç¤ºåç¨±éé•·';
                        validationMsg.className = 'validation-message error';
                        this.parentElement.classList.add('has-validation');
                    } else {
                        validationMsg.textContent = 'é¡¯ç¤ºåç¨±æ ¼å¼æ­£ç¢º';
                        validationMsg.className = 'validation-message success';
                        this.parentElement.classList.add('has-validation');
                    }
                });
                
                // åˆå§‹åŒ–è¨ˆæ•¸å™¨
                input.dispatchEvent(new Event('input'));
            });
        }

        // è¡¨å–®æäº¤å‰çš„æœ€çµ‚é©—è­‰
        function validateDisplayName(displayName) {
            if (!displayName || displayName.trim().length === 0) {
                return { valid: false, message: 'é¡¯ç¤ºåç¨±ä¸èƒ½ç‚ºç©º' };
            }
            
            if (displayName.length > 50) {
                return { valid: false, message: 'é¡¯ç¤ºåç¨±ä¸èƒ½è¶…é50å€‹å­—ç¬¦' };
            }
            
            // æª¢æŸ¥ç‰¹æ®Šå­—ç¬¦ï¼ˆå¯é¸ï¼‰
            const invalidChars = /[<"'\&]/;
            if (invalidChars.test(displayName)) {
                return { valid: false, message: 'é¡¯ç¤ºåç¨±åŒ…å«ç„¡æ•ˆå­—ç¬¦' };
            }
            
            return { valid: true, message: 'é¡¯ç¤ºåç¨±æœ‰æ•ˆ' };
        }

        // ç™»å‡ºåŠŸèƒ½
        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                window.location.href = '/login';
            }
        }

        // æ¨™ç±¤é åˆ‡æ›
        function switchTab(tabName) {
        // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤
        document.getElementById(tabName + 'Tab').classList.add('active');
        event.target.classList.add('active');
        
        // æ ¹æ“šæ¨™ç±¤è¼‰å…¥ç›¸æ‡‰å…§å®¹
        if (tabName === 'knowledge' && currentBotName) {
            // ğŸ†• æ·»åŠ : é‡ç½®åˆ†é ç‹€æ…‹ä¸¦è¼‰å…¥ç¬¬ä¸€é 
            knowledgeCurrentPage = 1;
            knowledgeSearchTerm = '';
            document.getElementById('knowledgeSearch').value = '';
            loadKnowledgeFiles(currentBotName, knowledgeCurrentPage, knowledgePageSize);
        } else if (tabName === 'conversations' && currentBotName) {
            currentPage = 1;
            selectedConversations.clear();
            updateSelectedUI();
            loadConversations(currentPage);
        }
        }

        // ç²å–æ©Ÿå™¨äººåˆ—è¡¨
        async function fetchBots() {
            try {
                const response = await fetch(`${window.location.origin}/api/bots`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });
                
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                const bots = await response.json();
                renderBotTable(bots);
            } catch (error) {
                console.error('ç²å–æ©Ÿå™¨äººåˆ—è¡¨å¤±æ•—:', error);
                showMessage('ç„¡æ³•ç²å–æ©Ÿå™¨äººåˆ—è¡¨: ' + error.message, true);
            }
        }

        // æ¸²æŸ“æ©Ÿå™¨äººè¡¨æ ¼ - æ”¯æŒé¡¯ç¤ºåç¨±
        function renderBotTable(bots) {
            botTableBody.innerHTML = '';
            if (bots.length === 0) {
                botTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#6c757d;">å°šæœªå‰µå»ºä»»ä½•æ©Ÿå™¨äºº</td></tr>';
                return;
            }

            bots.forEach(bot => {
                const row = document.createElement('tr');
                const isRunning = bot.status === 'running';
                const statusClass = isRunning ? 'status-running' : 'status-stopped';
                const statusText = isRunning ? 'é‹è¡Œä¸­' : 'å·²åœæ­¢';
                const toggleAction = isRunning ? 'stop' : 'start';
                const toggleText = isRunning ? 'â¹ï¸ åœæ­¢' : 'â–¶ï¸ å•Ÿå‹•';
                const toggleClass = isRunning ? 'btn-stop' : 'btn-start';
                
                // é¡¯ç¤ºåç¨±å„ªå…ˆï¼ŒæŠ€è¡“åç¨±ä½œç‚ºå‰¯è³‡è¨Š
                const displayName = bot.display_name || bot.name;
                const techNameInfo = (bot.display_name && bot.display_name !== bot.name) ? 
                    `<div class="bot-tech-name">æŠ€è¡“åç¨±: ${bot.name}</div>` : '';
                
                const publicUrl = `${window.location.origin}/${bot.name}`;
                row.innerHTML = `
                    <td>
                        <div class="bot-name-display">
                            <div class="bot-display-name">${displayName}</div>
                            ${techNameInfo}
                        </div>
                    </td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${isRunning ? `<a href="${publicUrl}" target="_blank" style="color:#007bff;" title="åœ¨æ–°åˆ†é ä¸­æ‰“é–‹èŠå¤©ä»‹é¢">${bot.port} ğŸ”—</a>` : bot.port}</td>
                    <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis;">${bot.system_role || 'æœªè¨­å®š'}</td>
                    <td>
                        <div class="btn-group">
                            <button class="${toggleClass}" onclick="toggleBot('${bot.name}', '${toggleAction}')">${toggleText}</button>
                            <button class="btn-edit" onclick="showManagePage('${bot.name}')">âš™ï¸ ç®¡ç†</button>
                        </div>
                    </td>
                `;
                botTableBody.appendChild(row);
            });
        }

        // å•Ÿå‹•/åœæ­¢æ©Ÿå™¨äºº
        async function toggleBot(botName, action) {
            try {
                const response = await fetch(`/api/bots/${botName}/${action}`, { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    showMessage(data.message);
                    fetchBots();
                } else {
                    throw new Error(data.detail || data.message);
                }
            } catch (error) {
                showMessage(`${action === 'start' ? 'å•Ÿå‹•' : 'åœæ­¢'} ${botName} å¤±æ•—: ` + error.message, true);
            }
        }

        // å‰µå»ºæ–°æ©Ÿå™¨äºº - åŒ…å«é¡¯ç¤ºåç¨±
        createBotForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const botName = document.getElementById('botName').value;
            const displayName = document.getElementById('botDisplayName').value.trim();
            const port = document.getElementById('botPort').value;
            const systemRole = document.getElementById('systemRole').value;

            // é©—è­‰é¡¯ç¤ºåç¨±
            const validation = validateDisplayName(displayName);
            if (!validation.valid) {
                showMessage(validation.message, true);
                return;
            }

            try {
                const response = await fetch('/api/bots/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        bot_name: botName, 
                        display_name: displayName,
                        port: parseInt(port),
                        system_role: systemRole
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage(data.message);
                    createBotForm.reset();
                    // é‡ç½®å­—ç¬¦è¨ˆæ•¸å™¨
                    setupDisplayNameValidation();
                    fetchBots();
                } else {
                    throw new Error(data.detail || data.message);
                }
            } catch (error) {
                showMessage('å‰µå»ºå¤±æ•—: ' + error.message, true);
            }
        });

        // è¼‰å…¥æ©Ÿå™¨äººé…ç½® - åŒ…å«é¡¯ç¤ºåç¨±
        async function loadBotConfig() {
            if (!currentBotName) return;
            
            try {
                const response = await fetch(`/api/bots/${currentBotName}/config`);
                if (response.ok) {
                    const data = await response.json();
                    currentBotConfig = data.config;
                    
                    // å¡«å……åŸºæœ¬ä¿¡æ¯
                    displayBotInfo(currentBotConfig);
                    
                    // å¡«å……ç·¨è¼¯è¡¨å–®ï¼ŒåŒ…æ‹¬é¡¯ç¤ºåç¨±
                    document.getElementById('editDisplayName').value = currentBotConfig.display_name || currentBotConfig.bot_name || '';
                    document.getElementById('editSystemRole').value = currentBotConfig.system_role || '';
                    document.getElementById('editTemperature').value = currentBotConfig.temperature || 0.7;
                    document.getElementById('editMaxTokens').value = currentBotConfig.max_tokens || 2000;
                    document.getElementById('editPort').value = currentBotConfig.port || '';
                    
                    // æ­£ç¢ºè¨­ç½® checkbox ç‹€æ…‹
                    document.getElementById('editDynamicRecommendations').checked = currentBotConfig.dynamic_recommendations_enabled === true;
                    document.getElementById('editDynamicRecommendationsCount').value = currentBotConfig.dynamic_recommendations_count || 0;
                    document.getElementById('editCiteSources').checked = currentBotConfig.cite_sources_enabled === true;
                    
                    // é‡æ–°åˆå§‹åŒ–é¡¯ç¤ºåç¨±é©—è­‰
                    setupDisplayNameValidation();
                    
                } else {
                    throw new Error('ç„¡æ³•è¼‰å…¥æ©Ÿå™¨äººé…ç½®');
                }
            } catch (error) {
                showMessage('è¼‰å…¥é…ç½®å¤±æ•—: ' + error.message, true, true);
            }
        }

        // é¡¯ç¤ºæ©Ÿå™¨äººåŸºæœ¬ä¿¡æ¯ - åŒ…å«é¡¯ç¤ºåç¨±
        function displayBotInfo(config) {
            const infoDiv = document.getElementById('botInfoDetails');
            const createdAt = config.created_at ? new Date(config.created_at).toLocaleString('zh-TW') : 'æœªçŸ¥';
            const updatedAt = config.updated_at ? new Date(config.updated_at).toLocaleString('zh-TW') : 'æœªæ›´æ–°';
            
            // é¡¯ç¤ºåç¨±è™•ç†
            const displayName = config.display_name || config.bot_name || 'æœªè¨­å®š';
            const techName = config.bot_name || 'æœªçŸ¥';
            
            infoDiv.innerHTML = `
                <div class="info-row">
                    <span class="info-label">é¡¯ç¤ºåç¨±:</span>
                    <span class="info-value">${displayName}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">æŠ€è¡“åç¨±:</span>
                    <span class="info-value">${techName}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">æœå‹™ç«¯å£:</span>
                    <span class="info-value">${config.port || 'æœªè¨­å®š'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">æº«åº¦åƒæ•¸:</span>
                    <span class="info-value">${config.temperature || 0.7}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">æœ€å¤§ Token:</span>
                    <span class="info-value">${config.max_tokens || 2000}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å‹•æ…‹æ¨è–¦å•é¡Œ:</span>
                    <span class="info-value">${config.dynamic_recommendations_enabled ? 'âœ… å·²å•Ÿç”¨' : 'âŒ æœªå•Ÿç”¨'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å¼•ç”¨ä¾†æº:</span>
                    <span class="info-value">${config.cite_sources_enabled ? 'âœ… å·²å•Ÿç”¨' : 'âŒ æœªå•Ÿç”¨'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å‰µå»ºè€…:</span>
                    <span class="info-value">${config.created_by || 'æœªçŸ¥'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å‰µå»ºæ™‚é–“:</span>
                    <span class="info-value">${createdAt}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">æœ€å¾Œæ›´æ–°:</span>
                    <span class="info-value">${updatedAt}</span>
                </div>
                <div style="margin-top: 15px;">
                    <div class="info-label">ç³»çµ±è§’è‰²:</div>
                    <div style="background: white; padding: 10px; border-radius: 4px; margin-top: 5px; white-space: pre-wrap;">${config.system_role || 'æœªè¨­å®š'}</div>
                </div>
            `;
        }

        // âœ… ä¿®å¾©å¾Œçš„åˆªé™¤æ–‡ä»¶å‡½æ•¸
            async function deleteFileSafe(botName, filename) {
        if (!botName || !filename) {
            showMessage('ç¼ºå°‘å¿…è¦åƒæ•¸ï¼šbotName æˆ– filename', true, true);
            return;
        }
        
        if (!confirm(`âš ï¸ ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤çŸ¥è­˜åº«ä¸­çš„æ–‡ä»¶å—ï¼Ÿ\n\næ–‡ä»¶å: ${filename}\n\næ­¤æ“ä½œå°‡æœƒï¼š\nâ€¢ å¾ä¼ºæœå™¨åˆªé™¤åŸå§‹æ–‡ä»¶\nâ€¢ å¾å‘é‡è³‡æ–™åº«ä¸­ç§»é™¤ç›¸é—œæ•¸æ“š\n\nâš ï¸ é€™å€‹æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
            return;
        }
        
        try {
            console.log('ğŸš€ é–‹å§‹åˆªé™¤æ–‡ä»¶:', { botName, filename });
            
            // âœ… ä½¿ç”¨ encodeURIComponent æ­£ç¢ºç·¨ç¢¼æª”å
            const encodedFilename = encodeURIComponent(filename);
            const deleteUrl = `/api/bots/${botName}/knowledge/files/${encodedFilename}`;
            
            console.log('ğŸ“¡ åˆªé™¤è«‹æ±‚URL:', deleteUrl);
            
            const response = await fetch(deleteUrl, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            console.log('ğŸ”¥ åˆªé™¤å›æ‡‰:', data);
            
            if (response.ok && data.success) {
                showMessage(`âœ… æ–‡ä»¶ "${filename}" å·²æˆåŠŸåˆªé™¤`, false, true);
                // é‡æ–°è¼‰å…¥æ–‡ä»¶åˆ—è¡¨
                loadKnowledgeFiles(botName);
            } else {
                throw new Error(data.message || `åˆªé™¤å¤±æ•— (HTTP ${response.status})`);
            }
            
        } catch (error) {
            console.error('âŒ åˆªé™¤æ–‡ä»¶å¤±æ•—:', error);
            showMessage(`âŒ åˆªé™¤å¤±æ•—: ${error.message}`, true, true);
        }
    }

            // ä¿å­˜æ©Ÿå™¨äººé…ç½® - åŒ…å«é¡¯ç¤ºåç¨±
            editBotForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentBotName) return;

                const displayName = document.getElementById('editDisplayName').value.trim();
                const systemRole = document.getElementById('editSystemRole').value;
                const temperature = parseFloat(document.getElementById('editTemperature').value);
                const maxTokens = parseInt(document.getElementById('editMaxTokens').value);
                const port = parseInt(document.getElementById('editPort').value);
                
                // é©—è­‰é¡¯ç¤ºåç¨±
                const validation = validateDisplayName(displayName);
                if (!validation.valid) {
                    showMessage(validation.message, true, true);
                    return;
                }
                
                // æ­£ç¢ºè®€å– checkbox å€¼
                const dynamicRecommendationsEnabled = document.getElementById('editDynamicRecommendations').checked;
                const dynamicRecommendationsCount = parseInt(document.getElementById('editDynamicRecommendationsCount').value) || 0;
                const citeSourcesEnabled = document.getElementById('editCiteSources').checked;

                try {
                    const response = await fetch(`/api/bots/${currentBotName}/config`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            display_name: displayName,
                            system_role: systemRole,
                            temperature: temperature,
                            max_tokens: maxTokens,
                            port: port,
                            dynamic_recommendations_enabled: dynamicRecommendationsEnabled,
                            dynamic_recommendations_count: dynamicRecommendationsCount,
                            cite_sources_enabled: citeSourcesEnabled
                        })
                    });
                    
                    const data = await response.json();
                    if (response.ok) {
                        showMessage('é…ç½®å·²ä¿å­˜æˆåŠŸï¼', false, true);
                        await loadBotConfig(); // é‡æ–°è¼‰å…¥é…ç½®
                    } else {
                        throw new Error(data.error || data.message);
                    }
                } catch (error) {
                    showMessage('ä¿å­˜é…ç½®å¤±æ•—: ' + error.message, true, true);
                }
            });

        // ğŸ†• ä¿®æ­£å¾Œçš„è¼‰å…¥çŸ¥è­˜åº«æ–‡ä»¶å‡½æ•¸
        async function loadKnowledgeFiles(botName, page = 1, limit = null, search = '') {
        
        const currentLimit = limit || knowledgePageSize;
        const currentSearch = search || knowledgeSearchTerm;
        
        const listDiv = document.getElementById('knowledgeFilesList');
        const statsDiv = document.getElementById('knowledgeStats');
        const totalFilesEl = document.getElementById('totalFilesCount');
        const totalChunksEl = document.getElementById('totalChunksCount');
        const statusEl = document.getElementById('knowledgeStatus');
        const pageStatsEl = document.getElementById('knowledgePageStats');
        const pageInfoEl = document.getElementById('knowledgePageInfo');
        
        listDiv.innerHTML = '<p>æ­£åœ¨è¼‰å…¥æ–‡ä»¶æ¸…å–®...</p>';
        pageStatsEl.textContent = 'è¼‰å…¥ä¸­...';
        statsDiv.style.display = 'none';

        try {
            const searchParam = currentSearch ? `&search=${encodeURIComponent(currentSearch)}` : '';
            const requestUrl = `/api/bots/${botName}/knowledge/files?page=${page}&limit=${currentLimit}${searchParam}`;
            
            console.log(`ğŸ” ç™¼é€åˆ†é è«‹æ±‚: ${requestUrl}`);
            
            const response = await fetch(requestUrl);
            if (!response.ok) {
                throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
            }
            
            const responseData = await response.json();
            console.log('âœ… åˆ†é APIå›æ‡‰:', responseData);

            if (responseData.success === false) {
                throw new Error(responseData.message || 'ç²å–æ–‡ä»¶æ¸…å–®å¤±æ•—');
            }

            // æ›´æ–°åˆ†é ç‹€æ…‹
            knowledgeCurrentPage = responseData.page || page;
            knowledgeTotalPages = responseData.total_pages || 1;
            const totalFiles = responseData.total || 0;
            const documents = responseData.documents || [];

            // æ›´æ–°çµ±è¨ˆä¿¡æ¯
            totalFilesEl.textContent = totalFiles;
            statusEl.textContent = totalFiles > 0 ? 'å°±ç·’' : 'ç©º';
            
            let totalChunks = 0;
            documents.forEach(doc => {
                const chunks = parseInt(doc.chunks) || 0;
                totalChunks += chunks;
            });
            totalChunksEl.textContent = totalChunks;
            
            statsDiv.style.display = 'flex';

            // æ›´æ–°åˆ†é ä¿¡æ¯
            pageStatsEl.textContent = `å…± ${totalFiles} å€‹æ–‡ä»¶`;
            pageInfoEl.textContent = `é é¢ ${knowledgeCurrentPage} / ${knowledgeTotalPages}`;
            
            // æ›´æ–°åˆ†é æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('knowledgePrevBtn').disabled = knowledgeCurrentPage <= 1;
            document.getElementById('knowledgeNextBtn').disabled = knowledgeCurrentPage >= knowledgeTotalPages;

            if (documents.length === 0) {
                const emptyMessage = currentSearch ? 
                    `æœªæ‰¾åˆ°åŒ…å« "${currentSearch}" çš„æ–‡ä»¶ã€‚` : 
                    'æ­¤çŸ¥è­˜åº«ä¸­æ²’æœ‰æ–‡ä»¶ã€‚';
                listDiv.innerHTML = `<p style="color:#6c757d; text-align:center; padding: 20px;">${emptyMessage}</p>`;
                return;
            }

            // å»ºç«‹æ–‡ä»¶æ¸…å–®è¡¨æ ¼
            let tableHtml = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 12px; text-align: left;">æ–‡ä»¶å</th>
                            <th style="padding: 12px; text-align: center;">Chunks</th>
                            <th style="padding: 12px; text-align: left;">ä¸Šå‚³è€…</th>
                            <th style="padding: 12px; text-align: left;">ä¸Šå‚³æ™‚é–“</th>
                            <th style="padding: 12px; text-align: center;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="fileTableBody">
            `;

            documents.forEach((doc, index) => {
                const filename = doc.filename || 'unknown';
                const chunkCount = doc.chunks || 0;
                const uploader = doc.uploader || 'æœªçŸ¥';
                const uploadTime = doc.upload_time_formatted || 'æœªçŸ¥';

                tableHtml += `
                    <tr data-file-id="${index}">
                        <td style="padding: 10px; word-break: break-all;">ğŸ“„ ${escapeHtml(filename)}</td>
                        <td style="padding: 10px; text-align: center;">${chunkCount}</td>
                        <td style="padding: 10px;">${escapeHtml(uploader)}</td>
                        <td style="padding: 10px;">${escapeHtml(uploadTime)}</td>
                        <td style="padding: 10px; text-align: center;">
                            <button class="btn-delete delete-file-btn" 
                                    data-bot-name="${escapeHtml(botName)}" 
                                    data-filename="${escapeHtml(filename)}"
                                    style="padding: 5px 10px; font-size: 0.9em; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;"
                                    title="åˆªé™¤æ–‡ä»¶: ${escapeHtml(filename)}">
                                ğŸ—‘ï¸ åˆªé™¤
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += '</tbody></table>';
            listDiv.innerHTML = tableHtml;

            // è¨­ç½®åˆªé™¤æŒ‰éˆ•äº‹ä»¶
            setupDeleteButtonEvents();

            console.log(`âœ… åˆ†é è¼‰å…¥å®Œæˆ: ç¬¬${knowledgeCurrentPage}é ï¼Œ${documents.length}å€‹æ–‡ä»¶ï¼Œç¸½å…±${totalFiles}å€‹`);

        } catch (error) {
            console.error('âŒ è¼‰å…¥çŸ¥è­˜åº«æ–‡ä»¶å¤±æ•—:', error);
            listDiv.innerHTML = `<p style="color:red; text-align:center; padding: 20px;">è¼‰å…¥æ–‡ä»¶æ¸…å–®å¤±æ•—: ${error.message}</p>`;
            statusEl.textContent = 'éŒ¯èª¤';
            totalFilesEl.textContent = '0';
            totalChunksEl.textContent = '0';
            pageStatsEl.textContent = 'è¼‰å…¥å¤±æ•—';
            statsDiv.style.display = 'flex';
        }
    }

    
function setupDeleteButtonEvents() {
    const tableBody = document.getElementById('fileTableBody');
    if (!tableBody) return;
    
    // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const newTableBody = tableBody.cloneNode(true);
    tableBody.parentNode.replaceChild(newTableBody, tableBody);
    
    // æ·»åŠ æ–°çš„äº‹ä»¶å§”è¨—
    newTableBody.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-file-btn') || 
            e.target.closest('.delete-file-btn')) {
            
            e.preventDefault();
            e.stopPropagation();
            
            const button = e.target.classList.contains('delete-file-btn') ? 
                        e.target : e.target.closest('.delete-file-btn');
            
            const botName = button.dataset.botName;
            const filename = button.dataset.filename;
            
            console.log('ğŸ—‘ï¸ åˆªé™¤æ–‡ä»¶è«‹æ±‚:', { botName, filename });
            deleteFileSafe(botName, filename);
        }
    });
}


    // ğŸ†• ä¿®æ”¹3: æ–°å¢æœç´¢å‡½æ•¸ - æ·»åŠ åˆ°scriptå€åŸŸ
    function searchKnowledgeFiles() {
        const searchInput = document.getElementById('knowledgeSearch');
        knowledgeSearchTerm = searchInput.value.trim();
        knowledgeCurrentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é 
        loadKnowledgeFiles(currentBotName, knowledgeCurrentPage, knowledgePageSize, knowledgeSearchTerm);
    }

    // ğŸ†• ä¿®æ”¹4: æ–°å¢é é¢å¤§å°è®Šæ›´å‡½æ•¸ - æ·»åŠ åˆ°scriptå€åŸŸ  
    function changeKnowledgePageSize() {
        const pageSizeSelect = document.getElementById('knowledgePageSize');
        knowledgePageSize = parseInt(pageSizeSelect.value);
        knowledgeCurrentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é 
        loadKnowledgeFiles(currentBotName, knowledgeCurrentPage, knowledgePageSize, knowledgeSearchTerm);
    }

        // ================= å°è©±è¨˜éŒ„ç®¡ç†åŠŸèƒ½ =================

        // è¼‰å…¥å°è©±è¨˜éŒ„ - ä¿®æ­£å­—æ®µåŒ¹é…
        async function loadConversations(page = 1, search = '') {
            if (!currentBotName) return; 
            
            const listDiv = document.getElementById('conversationsList');
            const statsDiv = document.getElementById('conversationStats');
            const pageInfo = document.getElementById('pageInfo');
            
            listDiv.innerHTML = '<p>æ­£åœ¨è¼‰å…¥å°è©±è¨˜éŒ„...</p>';
            
            try {
                const searchParam = search ? `&search=${encodeURIComponent(search)}` : '';
                const response = await fetch(`/api/bots/${currentBotName}/conversations?page=${page}&limit=10${searchParam}`);
                if (!response.ok) throw new Error(`è¼‰å…¥å¤±æ•—: ${response.status}`);
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'è¼‰å…¥å¤±æ•—');
                }
                
                const conversations = data.conversations;
                allConversationsOnPage = conversations;
                currentPage = data.page;
                totalPages = data.total_pages;
                
                // æ›´æ–°çµ±è¨ˆä¿¡æ¯
                statsDiv.textContent = `å…± ${data.total} æ¢å°è©±è¨˜éŒ„`;
                pageInfo.textContent = `é é¢ ${currentPage} / ${totalPages}`;
                
                // æ›´æ–°åˆ†é æŒ‰éˆ•ç‹€æ…‹
                document.getElementById('prevPageBtn').disabled = currentPage <= 1;
                document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
                
                if (conversations.length === 0) {
                    listDiv.innerHTML = '<p style="color:#6c757d; text-align:center; padding: 20px;">æ­¤æ©Ÿå™¨äººé‚„æ²’æœ‰å°è©±è¨˜éŒ„ã€‚</p>';
                    return;
                }
                
                // å»ºç«‹å°è©±è¨˜éŒ„è¡¨æ ¼ - ä½¿ç”¨æ­£ç¢ºçš„å­—æ®µå
                let tableHtml = `
                    <table class="conversation-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th style="padding: 8px; text-align: center; width: 50px;">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                </th>
                                <th style="padding: 8px; text-align: left; width: 25%;">ç”¨æˆ¶å•é¡Œ</th>
                                <th style="padding: 8px; text-align: left; width: 30%;">æ©Ÿå™¨äººå›ç­”</th>
                                <th style="padding: 8px; text-align: center; width: 15%;">Chunks</th>
                                <th style="padding: 8px; text-align: center; width: 12%;">æ™‚é–“</th>
                                <th style="padding: 8px; text-align: center; width: 13%;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                conversations.forEach(conv => {
                    const timestamp = conv.timestamp || conv.created_at;
                    const timeStr = timestamp ? new Date(timestamp).toLocaleString('zh-TW') : 'æœªçŸ¥';
                    
                    // ä¿®æ­£å¾Œçš„ Chunk æŒ‰éˆ•ç”Ÿæˆ - ä½¿ç”¨æ­£ç¢ºçš„å­—æ®µå
                    let chunkButtons = '';
                    if (conv.chunk_references && Array.isArray(conv.chunk_references) && conv.chunk_references.length > 0) {
                        chunkButtons = conv.chunk_references.map((ref, idx) => {
                            const chunkId = ref.id || '';
                            return `<button onclick="showChunkContent('${escapeHtml(chunkId)}')" class="chunk-btn" title="æŸ¥çœ‹ Chunk: ${escapeHtml(chunkId)}">${idx + 1}</button>`;
                        }).join('');
                    } else {
                        chunkButtons = '<span style="color: #6c757d;">ç„¡</span>';
                    }
                    
                    const statusIcon = conv.error_occurred ? 'âŒ' : 'âœ…';
                    const statusTitle = conv.error_occurred ? 'è™•ç†å¤±æ•—' : 'è™•ç†æˆåŠŸ';
                    const rowClass = conv.error_occurred ? 'error-row' : 'success-row';
                    
                    tableHtml += `
                        <tr class="${rowClass}" style="border-bottom: 1px solid #eee;">
                            <td style="padding: 8px; text-align: center;">
                                <input type="checkbox" value="${conv.id}" onchange="toggleConversationSelection(${conv.id})">
                            </td>
                            <td style="padding: 8px; word-break: break-word; max-width: 200px;">
                                <span title="${escapeHtml(conv.user_query || '')}">${escapeHtml((conv.user_query || '').substring(0, 100))}</span>
                                <div class="conversation-meta">
                                    ç”¨æˆ¶: ${escapeHtml(conv.user_id || '')}
                                </div>
                            </td>
                            <td style="padding: 8px; word-break: break-word; max-width: 250px;">
                                <span title="${escapeHtml(conv.ai_response || '')}">${escapeHtml((conv.ai_response || '').substring(0, 150))}</span>
                                ${conv.collection_used ? `<div class="conversation-meta" style="color: #007bff;">ğŸ“š ${escapeHtml(conv.collection_used)}</div>` : ''}
                            </td>
                            <td style="padding: 8px; text-align: center;">${chunkButtons}</td>
                            <td style="padding: 8px; text-align: center; font-size: 0.9em;">
                                <div>${escapeHtml(timeStr)}</div>
                                ${conv.processing_time_ms ? `<div class="conversation-meta">${conv.processing_time_ms}ms</div>` : ''}
                            </td>
                            <td style="padding: 8px; text-align: center;">
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <button onclick="showConversationDetail(${conv.id})" class="btn-config" style="padding: 3px 6px; font-size: 0.8em;" title="${statusTitle}">
                                        ${statusIcon} è©³æƒ…
                                    </button>
                                    <button onclick="deleteConversation(${conv.id})" class="btn-delete" style="padding: 3px 6px; font-size: 0.8em;">ğŸ—‘ï¸</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                listDiv.innerHTML = tableHtml;
                
                selectedConversations.clear();
                updateSelectedUI();
                
            } catch (error) {
                listDiv.innerHTML = `<p style="color:red; text-align:center; padding: 20px;">è¼‰å…¥å°è©±è¨˜éŒ„å¤±æ•—: ${error.message}</p>`;
                statsDiv.textContent = 'è¼‰å…¥å¤±æ•—';
            }
        }

        // æœç´¢å°è©±
        function searchConversations() {
            const searchInput = document.getElementById('conversationSearch');
            const searchTerm = searchInput.value.trim();
            currentPage = 1;
            selectedConversations.clear();
            updateSelectedUI();
            loadConversations(currentPage, searchTerm);
        }

        // åˆ‡æ›å–®å€‹å°è©±é¸æ“‡
        function toggleConversationSelection(conversationId) {
            if (selectedConversations.has(conversationId)) {
                selectedConversations.delete(conversationId);
            } else {
                selectedConversations.add(conversationId);
            }
            updateSelectedUI();
        }

        // åˆ‡æ›å…¨é¸
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
            
            if (selectAllCheckbox.checked) {
                checkboxes.forEach(cb => {
                    cb.checked = true;
                    selectedConversations.add(parseInt(cb.value));
                });
            } else {
                checkboxes.forEach(cb => {
                    cb.checked = false;
                    selectedConversations.delete(parseInt(cb.value));
                });
            }
            updateSelectedUI();
        }

        // æ›´æ–°é¸æ“‡ç‹€æ…‹UI
        function updateSelectedUI() {
            const selectedCount = selectedConversations.size;
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const countSpan = document.getElementById('selectedCount');
            const selectAllBtn = document.getElementById('selectAllBtn');
            
            countSpan.textContent = `å·²é¸ä¸­ ${selectedCount} é …`;
            deleteBtn.disabled = selectedCount === 0;
            
            if (selectedCount === 0) {
                selectAllBtn.textContent = 'â˜‘ï¸ å…¨é¸';
            } else if (selectedCount === allConversationsOnPage.length) {
                selectAllBtn.textContent = 'â¬œ å–æ¶ˆå…¨é¸';
            } else {
                selectAllBtn.textContent = 'â˜‘ï¸ å…¨é¸';
            }
        }

        // é¡¯ç¤º Chunk å…§å®¹ (ä¿®æ­£ç‰ˆ)
        async function showChunkContent(chunkId) {
            if (!currentBotName || chunkId === undefined) return;
            
            const modal = document.getElementById('chunkModal');
            const title = document.getElementById('chunkModalTitle');
            const content = document.getElementById('chunkContent');
            const metadata = document.getElementById('chunkMetadata');
            
            title.textContent = `Chunk å…§å®¹: #${chunkId}`;
            content.textContent = 'è¼‰å…¥ä¸­...';
            metadata.innerHTML = '';
            modal.style.display = 'flex';
            
            try {
                const response = await fetch(`/api/bots/${currentBotName}/conversations/chunk/${encodeURIComponent(chunkId)}`);
                if (!response.ok) throw new Error(`è¼‰å…¥å¤±æ•— (${response.status})`);
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'è¼‰å…¥å¤±æ•—');
                }
                
                const chunk = data.chunk;
                content.textContent = chunk.content;
                
                const stats = chunk.content_stats || {};
                metadata.innerHTML = `
                    <h4>ğŸ“Š Chunk è©³ç´°ä¿¡æ¯</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <div><strong>Chunk ID:</strong> ${escapeHtml(chunk.chunk_id)}</div>
                        <div><strong>Token æ•¸é‡:</strong> ${chunk.token_count || 'N/A'}</div>
                        <div><strong>ä¾†æºæ–‡ä»¶:</strong> ${escapeHtml(chunk.original_filename || chunk.source_file || 'N/A')}</div>
                        <div><strong>å“è³ªåˆ†æ•¸:</strong> ${chunk.quality_score || 'N/A'}</div>
                    </div>
                `;
                
            } catch (error) {
                content.textContent = `è¼‰å…¥ Chunk å…§å®¹å¤±æ•—: ${error.message}`;
                metadata.innerHTML = '';
            }
        }

        // é¡¯ç¤ºå°è©±è©³æƒ… (ä¿®æ­£ç‰ˆ) - ä½¿ç”¨æ­£ç¢ºçš„å­—æ®µå
        function showConversationDetail(conversationId) {
            const conversation = allConversationsOnPage.find(conv => conv.id === conversationId);
            if (!conversation) return;

            const modal = document.getElementById('conversationDetailModal');
            const content = document.getElementById('conversationDetailContent');

            const timestamp = conversation.timestamp || conversation.created_at;
            const timeStr = timestamp ? new Date(timestamp).toLocaleString('zh-TW') : 'æœªçŸ¥';
            
            content.innerHTML = `
                <div class="info-card">
                    <h4>ğŸ“Š å°è©±åŸºæœ¬ä¿¡æ¯</h4>
                    <div class="info-row"><span class="info-label">å°è©±ID:</span><span class="info-value">${conversation.id}</span></div>
                    <div class="info-row"><span class="info-label">ç”¨æˆ¶ID:</span><span class="info-value">${escapeHtml(conversation.user_id)}</span></div>
                    <div class="info-row"><span class="info-label">æ™‚é–“:</span><span class="info-value">${escapeHtml(timeStr)}</span></div>
                    <div class="info-row"><span class="info-label">ç‹€æ…‹:</span><span class="info-value">${conversation.error_occurred ? 'âŒ è™•ç†å¤±æ•—' : 'âœ… è™•ç†æˆåŠŸ'}</span></div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4>â“ ç”¨æˆ¶å•é¡Œ</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff;">
                        ${escapeHtml(conversation.user_query)}
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4>ğŸ¤– æ©Ÿå™¨äººå›ç­”</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #28a745;">
                        ${escapeHtml(conversation.ai_response)}
                    </div>
                </div>

                ${(conversation.chunk_references && conversation.chunk_references.length > 0) ? `
                <div>
                    <h4>ğŸ“š ç›¸é—œ Chunks</h4>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        ${conversation.chunk_references.map((ref, idx) => 
                            `<button onclick="showChunkContent('${escapeHtml(ref.id || '')}')" class="chunk-btn">Chunk ${idx + 1}</button>`
                        ).join('')}
                    </div>
                </div>
                ` : ''}
            `;

            modal.style.display = 'flex';
        }

        // åˆªé™¤å–®æ¢å°è©±è¨˜éŒ„
        async function deleteConversation(conversationId) {
            if (!currentBotName || !conversationId) return;
            
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™æ¢å°è©±è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/bots/${currentBotName}/conversations/${conversationId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showMessage('å°è©±è¨˜éŒ„å·²åˆªé™¤', false, true);
                    loadConversations(currentPage);
                } else {
                    throw new Error(data.message || 'åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                showMessage('åˆªé™¤å°è©±è¨˜éŒ„å¤±æ•—: ' + error.message, true, true);
            }
        }

        // æ‰¹é‡åˆªé™¤å°è©±è¨˜éŒ„
        async function deleteSelectedConversations() {
            if (selectedConversations.size === 0) return;
            
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${selectedConversations.size} æ¢å°è©±è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/bots/${currentBotName}/conversations`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        conversation_ids: Array.from(selectedConversations) 
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showMessage(data.message, false, true);
                    selectedConversations.clear();
                    updateSelectedUI();
                    loadConversations(currentPage);
                } else {
                    throw new Error(data.message || 'æ‰¹é‡åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                showMessage('æ‰¹é‡åˆªé™¤å¤±æ•—: ' + error.message, true, true);
            }
        }

        // é—œé–‰å„ç¨® Modal
        function closeChunkModal() {
            document.getElementById('chunkModal').style.display = 'none';
        }

        function closeConversationDetailModal() {
            document.getElementById('conversationDetailModal').style.display = 'none';
        }

        // åˆªé™¤æ©Ÿå™¨äººç¢ºèª
        async function deleteBotConfirm() {
            if (!currentBotName) return;
            
            if (!confirm(`âš ï¸ ç¢ºå®šè¦å®Œå…¨åˆªé™¤æ©Ÿå™¨äºº "${currentBotName}" å—ï¼Ÿ\n\né€™å°‡æœƒåˆªé™¤ï¼š\nâ€¢ æ©Ÿå™¨äººé…ç½®\nâ€¢ æ‰€æœ‰çŸ¥è­˜åº«æ–‡ä»¶\nâ€¢ å°è©±è¨˜éŒ„\n\næ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼`)) {
                return;
            }

            try {
                const response = await fetch(`/api/bots/${currentBotName}`, { method: 'DELETE' });
                const data = await response.json();
                if (response.ok) {
                    showMessage(`æ©Ÿå™¨äºº ${currentBotName} å·²å®Œå…¨åˆªé™¤`);
                    showMainPage();
                } else {
                    throw new Error(data.detail || data.message);
                }
            } catch (error) {
                showMessage('åˆªé™¤å¤±æ•—: ' + error.message, true);
            }
        }

        // é é¢è¼‰å…¥å’Œå®šæœŸåˆ·æ–°
        document.addEventListener('DOMContentLoaded', () => {
            fetchBots();
            setupDisplayNameValidation(); // åˆå§‹åŒ–é¡¯ç¤ºåç¨±é©—è­‰
            // æ¯10ç§’åˆ·æ–°ä¸€æ¬¡åˆ—è¡¨ï¼ˆåƒ…åœ¨ä¸»é é¢æ™‚ï¼‰
            setInterval(() => {
                if (document.getElementById('mainPage').classList.contains('active')) {
                    fetchBots();
                }
            }, 10000);
        });

        // é»æ“Š Modal å¤–éƒ¨é—œé–‰
        document.getElementById('chunkModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('chunkModal')) {
                closeChunkModal();
            }
        });

        document.getElementById('conversationDetailModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('conversationDetailModal')) {
                closeConversationDetailModal();
            }
        });

        // æœç´¢æ¡† Enter éµæ”¯æŒ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const activeElement = document.activeElement;
                if (activeElement && activeElement.id === 'conversationSearch') {
                    searchConversations();
                }
                // ğŸ†• æ·»åŠ : çŸ¥è­˜åº«æœç´¢Enteréµæ”¯æŒ
                if (activeElement && activeElement.id === 'knowledgeSearch') {
                    searchKnowledgeFiles();
                }
            }
        });

        // ç€è¦½å™¨å‰é€²å¾Œé€€æŒ‰éµæ”¯æŒ
        window.addEventListener('popstate', (e) => {
            if (e.state && e.state.page === 'manage') {
                showManagePage(e.state.botName);
            } else {
                showMainPage();
            }
        });

        // æ›´æ–° showManagePage å‡½æ•¸ä»¥æ”¯æŒç€è¦½å™¨æ­·å²
        function showManagePageWithHistory(botName) {
            history.pushState({page: 'manage', botName: botName}, '', `#manage-${botName}`);
            showManagePage(botName);
        }

        // æ›´æ–° showMainPage å‡½æ•¸ä»¥æ”¯æŒç€è¦½å™¨æ­·å²
        function showMainPageWithHistory() {
            history.pushState({page: 'main'}, '', '#main');
            showMainPage();
        }

        // æª¢æŸ¥é›†åˆç‹€æ…‹
async function checkCollectionsStatus() {
    try {
        const response = await fetch(`${window.location.origin}/api/emergency/collections-status`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        const statusDiv = document.getElementById('collectionsStatus');
        
        if (data.success) {
            let html = '<div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px;">';
            html += '<h5>ğŸ“Š æ•¸æ“šåº«é›†åˆç‹€æ…‹ï¼š</h5>';
            
            if (Object.keys(data.collections_status).length === 0) {
                html += '<p style="color: #28a745;">âœ… æ•¸æ“šåº«ä¸­æ²’æœ‰å‘é‡æ•¸æ“š</p>';
            } else {
                for (const [table, collections] of Object.entries(data.collections_status)) {
                    html += `<h6>è¡¨: ${table}</h6><ul>`;
                    for (const [collection, count] of Object.entries(collections)) {
                        const color = collection === 'test_01' ? '#dc3545' : '#007bff';
                        html += `<li style="color: ${color};">${collection}: ${count} æ¢è¨˜éŒ„</li>`;
                    }
                    html += '</ul>';
                }
            }
            
            html += '</div>';
            statusDiv.innerHTML = html;
            statusDiv.style.display = 'block';
        } else {
            statusDiv.innerHTML = `<div style="color: #dc3545;">âŒ ç²å–ç‹€æ…‹å¤±æ•—: ${data.message}</div>`;
            statusDiv.style.display = 'block';
        }
        
    } catch (error) {
        console.error('ç²å–é›†åˆç‹€æ…‹å¤±æ•—:', error);
        document.getElementById('collectionsStatus').innerHTML = 
            `<div style="color: #dc3545;">âŒ è«‹æ±‚å¤±æ•—: ${error.message}</div>`;
        document.getElementById('collectionsStatus').style.display = 'block';
    }
}

async function uploadFile() {
    const fileInput = document.getElementById('fileUpload');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadStatus = document.getElementById('uploadStatus');
    
    // âœ… æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆ
    if (!fileInput.files || fileInput.files.length === 0) {
        showMessage('è«‹å…ˆé¸æ“‡è¦ä¸Šå‚³çš„æª”æ¡ˆ', true, true);
        return;
    }
    
    if (!currentBotName) {
        showMessage('è«‹å…ˆé¸æ“‡ä¸€å€‹æ©Ÿå™¨äºº', true, true);
        return;
    }
    
    const files = Array.from(fileInput.files);  // âœ… å–å¾—æ‰€æœ‰æª”æ¡ˆ
    
    // æª”æ¡ˆå¤§å°æª¢æŸ¥ (æ¯å€‹æª”æ¡ˆæœ€å¤§ 50MB)
    for (const file of files) {
        if (file.size > 50 * 1024 * 1024) {
            showMessage(`æª”æ¡ˆ "${file.name}" å¤§å°ä¸èƒ½è¶…é 50MB`, true, true);
            return;
        }
    }
    
    // æ›´æ–°UIç‹€æ…‹
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<span id="uploadIcon">â³</span> ä¸Šå‚³ä¸­...';
    uploadStatus.textContent = `æ­£åœ¨è™•ç† ${files.length} å€‹æª”æ¡ˆ...`;
    uploadStatus.style.color = '#007bff';
    
    try {
        const formData = new FormData();
        
        // âœ… æ·»åŠ æ‰€æœ‰æª”æ¡ˆ
        files.forEach(file => {
            formData.append('files', file);  // æ³¨æ„ï¼šå¾Œå°æœŸæœ›çš„åƒæ•¸åæ˜¯ 'files'
        });
        
        // âœ… ä½¿ç”¨æ‰¹æ¬¡ä¸Šå‚³ API
        const response = await fetch(`/api/bots/${currentBotName}/knowledge/upload-batch`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            uploadBtn.innerHTML = '<span id="uploadIcon">âœ…</span> ä¸Šå‚³æˆåŠŸ';
            uploadStatus.textContent = `æˆåŠŸä¸Šå‚³ ${result.stats.successful_files}/${result.stats.total_files} å€‹æª”æ¡ˆ`;
            uploadStatus.style.color = '#28a745';
            
            // é¡¯ç¤ºè©³ç´°çµæœ
            let successCount = 0;
            let errorMessages = [];
            
            result.results.forEach(fileResult => {
                if (fileResult.success) {
                    successCount++;
                } else {
                    errorMessages.push(`${fileResult.filename}: ${fileResult.message}`);
                }
            });
            
            let message = `æ‰¹æ¬¡ä¸Šå‚³å®Œæˆï¼š${successCount} å€‹æˆåŠŸ`;
            if (errorMessages.length > 0) {
                message += `ï¼Œ${errorMessages.length} å€‹å¤±æ•—`;
            }
            
            showMessage(message, errorMessages.length > 0, true);
            
            // å¦‚æœæœ‰éŒ¯èª¤ï¼Œé¡¯ç¤ºè©³ç´°ä¿¡æ¯
            if (errorMessages.length > 0) {
                console.warn('ä¸Šå‚³éŒ¯èª¤è©³æƒ…:', errorMessages);
            }
            
            // æ¸…ç©ºé¸æ“‡ä¸¦é‡æ–°è¼‰å…¥æª”æ¡ˆåˆ—è¡¨
            fileInput.value = '';
            setTimeout(() => {
        // ğŸ”§ ä¿®æ”¹: åˆ·æ–°ç•¶å‰åˆ†é è€Œä¸æ˜¯é‡ç½®åˆ°ç¬¬ä¸€é 
        loadKnowledgeFiles(currentBotName, knowledgeCurrentPage, knowledgePageSize, knowledgeSearchTerm);
        // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<span id="uploadIcon">ğŸ“¤</span> ä¸Šå‚³æ–‡ä»¶';
        uploadStatus.textContent = '';
     }, 2000);
            
        } else {
            throw new Error(result.message || 'æ‰¹æ¬¡ä¸Šå‚³å¤±æ•—');
        }
        
    } catch (error) {
        console.error('æ‰¹æ¬¡ä¸Šå‚³å¤±æ•—:', error);
        
        uploadBtn.innerHTML = '<span id="uploadIcon">âŒ</span> ä¸Šå‚³å¤±æ•—';
        uploadStatus.textContent = `æ‰¹æ¬¡ä¸Šå‚³å¤±æ•—: ${error.message}`;
        uploadStatus.style.color = '#dc3545';
        
        showMessage(`æ‰¹æ¬¡ä¸Šå‚³å¤±æ•—: ${error.message}`, true, true);
        
        // é‡ç½®æŒ‰éˆ•
        setTimeout(() => {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<span id="uploadIcon">ğŸ“¤</span> ä¸Šå‚³æª”æ¡ˆ';
            uploadStatus.textContent = '';
        }, 3000);
    }
}

// ç·Šæ€¥æ¸…ç©º test_01
async function emergencyClearTest01() {
    // é›™é‡ç¢ºèª
    const confirm1 = confirm('âš ï¸ è­¦å‘Šï¼šå³å°‡åˆªé™¤ test_01 çš„æ‰€æœ‰å‘é‡æ•¸æ“šï¼\n\næ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ');
    if (!confirm1) return;
    
    const confirm2 = confirm('ğŸš¨ æœ€å¾Œç¢ºèªï¼š\n\næ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ test_01 é›†åˆçš„æ‰€æœ‰æ•¸æ“šå—ï¼Ÿ\n\né»æ“Š"ç¢ºå®š"å°‡ç«‹å³åŸ·è¡Œåˆªé™¤æ“ä½œã€‚');
    if (!confirm2) return;
    
    const resultsDiv = document.getElementById('emergencyResults');
    resultsDiv.innerHTML = '<div style="color: #007bff;">ğŸ”„ æ­£åœ¨åŸ·è¡Œç·Šæ€¥æ¸…ç©ºæ“ä½œï¼Œè«‹ç¨å€™...</div>';
    resultsDiv.style.display = 'block';
    
    try {
        const response = await fetch(`${window.location.origin}/api/emergency/clear-test01`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        
        if (data.success) {
            let html = '<div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 4px;">';
            html += `<h5>âœ… æ¸…ç©ºæˆåŠŸï¼</h5>`;
            html += `<p><strong>ç¸½è¨ˆåˆªé™¤ï¼š</strong>${data.total_deleted} æ¢è¨˜éŒ„</p>`;
            html += '<h6>è©³ç´°çµæœï¼š</h6><ul>';
            
            data.details.forEach(detail => {
                html += `<li>${detail}</li>`;
            });
            
            html += '</ul></div>';
            resultsDiv.innerHTML = html;
            
            // åˆ·æ–°çŸ¥è­˜åº«æ–‡ä»¶åˆ—è¡¨
            if (currentBotName === 'test_01') {
                setTimeout(() => {
                    loadKnowledgeFiles(currentBotName);
                }, 2000);
            }
            
        } else {
            resultsDiv.innerHTML = `
                <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px;">
                    <h5>âŒ æ¸…ç©ºå¤±æ•—</h5>
                    <p>${data.message}</p>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('ç·Šæ€¥æ¸…ç©ºå¤±æ•—:', error);
        resultsDiv.innerHTML = `
            <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px;">
                <h5>âŒ è«‹æ±‚å¤±æ•—</h5>
                <p>${error.message}</p>
            </div>
        `;
    }


// é‡ç½®ä¸Šå‚³æŒ‰éˆ•ç‹€æ…‹
function resetUploadButton() {
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadIcon = document.getElementById('uploadIcon');
    const uploadStatus = document.getElementById('uploadStatus');
    
    uploadBtn.disabled = false;
    uploadIcon.textContent = 'ğŸ“¤';
    uploadBtn.innerHTML = '<span>ğŸ“¤</span> ä¸Šå‚³æ–‡ä»¶';
    uploadStatus.textContent = '';
}

    
    // å¢å¼·çš„æ–‡ä»¶ä¸Šå‚³åŠŸèƒ½

function setupFileUpload() {
    const fileInput = document.getElementById('fileUpload');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadStatus = document.getElementById('uploadStatus');
    
    if (!fileInput || !uploadBtn) {
        console.warn('æª”æ¡ˆä¸Šå‚³çµ„ä»¶æœªæ‰¾åˆ°');
        return;
    }
    
    // æª”æ¡ˆé¸æ“‡äº‹ä»¶
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            const fileCount = this.files.length;
            let totalSize = 0;
            let fileList = [];
            
            for (let i = 0; i < fileCount; i++) {
                totalSize += this.files[i].size;
                fileList.push(this.files[i].name);
            }
            
            const totalSizeMB = (totalSize / 1024 / 1024).toFixed(2);
            
            uploadStatus.innerHTML = `
                å·²é¸æ“‡: ${fileCount} å€‹æª”æ¡ˆ (å…± ${totalSizeMB} MB)<br>
                <small style="color: #6c757d;">${fileList.slice(0, 3).join(', ')}${fileCount > 3 ? ` ç­‰ ${fileCount} å€‹æª”æ¡ˆ` : ''}</small>
            `;
            uploadStatus.style.color = '#007bff';
            
            uploadBtn.style.background = '#28a745';
            uploadBtn.innerHTML = '<span>âœ…</span> ç¢ºèªæ‰¹æ¬¡ä¸Šå‚³';
        } else {
            resetUploadButton();
        }
    });
    
    // å»ºç«‹æ‹–æ‹½å€åŸŸ
    const dropZone = document.createElement('div');
    dropZone.className = 'drop-zone';
    dropZone.innerHTML = '<p>ğŸ—‚ï¸ æˆ–ç›´æ¥æ‹–æ”¾å¤šå€‹æª”æ¡ˆåˆ°æ­¤å€åŸŸ (æ”¯æ´æ‰¹æ¬¡ä¸Šå‚³)</p>';
    
    fileInput.parentElement.appendChild(dropZone);
    
    // âœ… æ”¹å–„æ‹–æ‹½äº‹ä»¶è™•ç†
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });
    
    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            // âœ… ç›´æ¥è¨­ç½®æª”æ¡ˆä¸¦è§¸ç™¼ change äº‹ä»¶
            fileInput.files = files;
            fileInput.dispatchEvent(new Event('change', { bubbles: true }));
            
            // é¡¯ç¤ºæ‹–æ‹½æˆåŠŸæç¤º
            dropZone.innerHTML = `<p style="color: #28a745;">âœ… å·²æ¥æ”¶ ${files.length} å€‹æª”æ¡ˆï¼Œé»æ“Šä¸Šå‚³æŒ‰éˆ•é–‹å§‹è™•ç†</p>`;
            setTimeout(() => {
                dropZone.innerHTML = '<p>ğŸ—‚ï¸ æˆ–ç›´æ¥æ‹–æ”¾å¤šå€‹æª”æ¡ˆåˆ°æ­¤å€åŸŸ (æ”¯æ´æ‰¹æ¬¡ä¸Šå‚³)</p>';
            }, 3000);
        }
    });
    
    dropZone.addEventListener('click', () => {
        fileInput.click();
    });
    
    console.log('âœ… å¤šæª”æ¡ˆä¸Šå‚³èˆ‡æ‹–æ‹½åŠŸèƒ½å·²åˆå§‹åŒ–');
}
// é é¢è¼‰å…¥å¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', setupFileUpload);


    
}
    </script>
</body>
</html>